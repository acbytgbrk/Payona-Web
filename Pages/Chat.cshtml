@page
@model ChatModel
@{
    ViewData["Title"] = "Sohbet - Payona";
}

<div style="max-width: 900px; margin: 0 auto; height: calc(100vh - 120px);">
    <div class="card" style="height: 100%; display: flex; flex-direction: column;">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
            <div>
                <h2 class="card-title" id="chatUserName">Sohbet</h2>
                <p style="color: var(--text-secondary); font-size: 0.9rem;" id="chatUserInfo"></p>
            </div>
            <button class="btn btn-secondary" id="sendMatchRequestBtn">Eşleşme Talebi Gönder</button>
        </div>

        <div class="chat-container" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
            <div class="chat-messages" id="chatMessages" style="flex: 1; overflow-y: auto; padding: 1rem;">
                <div class="text-center" style="padding: 2rem; color: var(--text-secondary);">
                    <div class="spinner" style="margin: 0 auto;"></div>
                    <p class="mt-2">Mesajlar yükleniyor...</p>
                </div>
            </div>

            <div class="chat-input-area" style="flex-shrink: 0; display: flex; gap: 1rem; padding: 1rem; border-top: 1px solid var(--border-color); background-color: var(--bg-primary);">
                <input 
                    type="text" 
                    id="messageInput" 
                    class="form-input" 
                    placeholder="Mesajınızı yazın..." 
                    style="flex: 1;"
                />
                <button class="btn btn-primary" id="sendMessageBtn">Gönder</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script type="module">
        import { authService } from '/js/modules/auth.js';
        import { chatService } from '/js/modules/chat.js';
        import { matchService } from '/js/modules/match.js';
        import { fingerprintService } from '/js/modules/fingerprint.js';
        import { mealRequestService } from '/js/modules/mealRequest.js';

        // Check authentication
        if (!authService.isAuthenticated()) {
            window.location.href = '/';
        }

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const otherUserIdParam = urlParams.get('userId');
        const otherUserName = urlParams.get('userName');
        const requestId = urlParams.get('requestId'); // fingerprintId or mealRequestId
        const requestType = urlParams.get('requestType'); // 'fingerprint' or 'mealRequest'

        if (!otherUserIdParam) {
            window.location.href = '/Dashboard';
        }

        const currentUser = authService.getCurrentUser();
        if (!currentUser) {
            window.location.href = '/';
        }

        // Prevent chatting with yourself
        if (currentUser.id === otherUserIdParam) {
            alert('Kendinizle sohbet edemezsiniz');
            window.location.href = '/Dashboard';
        }

        const otherUserId = otherUserIdParam;
        let stopPolling = null;
        let myFingerprints = [];
        let myMealRequests = [];

        // Set chat header
        document.getElementById('chatUserName').textContent = otherUserName || 'Sohbet';
        if (otherUserName) {
            document.getElementById('chatUserInfo').textContent = `${otherUserName} ile sohbet ediyorsunuz`;
        }

        // Load messages
        async function loadMessages() {
            try {
                const messages = await chatService.getConversation(otherUserId);
                renderMessages(messages);
            } catch (error) {
                console.error('Error loading messages:', error);
                const errorMsg = error.message || 'Mesajlar yüklenemedi';
                document.getElementById('chatMessages').innerHTML = 
                    `<p class="text-error">${errorMsg}</p>`;
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('chatMessages');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">Henüz mesaj yok. Konuşmayı başlatın!</p>';
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isSent = msg.senderId === currentUser.id;
                return `
                    <div class="message ${isSent ? 'message-sent' : 'message-received'}">
                        <div style="font-weight: 500; margin-bottom: 0.25rem;">
                            ${isSent ? 'Siz' : (msg.senderName || 'Kullanıcı')}
                        </div>
                        <div>${msg.content}</div>
                        <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.25rem;">
                            ${new Date(msg.createdAt).toLocaleTimeString('tr-TR')}
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        // Load user's active fingerprints and meal requests for match creation
        async function loadUserRequests() {
            try {
                const [fingerprints, mealRequests] = await Promise.all([
                    fingerprintService.getMy(),
                    mealRequestService.getMy()
                ]);
                myFingerprints = fingerprints.filter(f => f.status === 'active');
                myMealRequests = mealRequests.filter(m => m.status === 'active');
            } catch (error) {
                console.error('Error loading user requests:', error);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) return;

            // Prevent sending message to yourself
            if (currentUser.id === otherUserId) {
                alert('Kendinize mesaj gönderemezsiniz');
                return;
            }

            const sendBtn = document.getElementById('sendMessageBtn');
            sendBtn.disabled = true;
            const originalText = sendBtn.textContent;
            sendBtn.textContent = 'Gönderiliyor...';

            try {
                console.log('Sending message to:', otherUserId, 'Content:', content);
                const result = await chatService.sendMessage(otherUserId, content);
                console.log('Message sent successfully:', result);
                input.value = '';
                await loadMessages(); // Reload to show new message
            } catch (error) {
                console.error('Send message error:', error);
                const errorMessage = error.message || 'Mesaj gönderilemedi';
                alert(errorMessage);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = originalText;
            }
        }

        async function sendMatchRequest() {
            // Prevent sending match request to yourself
            if (currentUser.id === otherUserId) {
                alert('Kendinize eşleşme talebi gönderemezsiniz');
                return;
            }

            if (!confirm('Bu kullanıcıya eşleşme talebi göndermek istiyor musunuz?')) return;

            const sendBtn = document.getElementById('sendMatchRequestBtn');
            sendBtn.disabled = true;
            const originalText = sendBtn.textContent;
            sendBtn.textContent = 'Gönderiliyor...';

            try {
                // If requestId and requestType are provided from URL, use them
                let fingerprintId = null;
                let mealRequestId = null;

                if (requestId && requestType) {
                    // Use the provided request ID
                    if (requestType === 'fingerprint') {
                        // I have a fingerprint, need other user's meal request
                        fingerprintId = requestId;
                        const myFingerprint = myFingerprints.find(f => f.id === fingerprintId);
                        if (myFingerprint) {
                            const otherMealRequests = await mealRequestService.getAll();
                            const matchingRequest = otherMealRequests.find(m => 
                                m.userId === otherUserId && 
                                m.status === 'active' &&
                                m.mealType === myFingerprint.mealType
                            );
                            if (matchingRequest) {
                                mealRequestId = matchingRequest.id;
                            }
                        }
                    } else if (requestType === 'mealRequest') {
                        // I have a meal request, need other user's fingerprint
                        mealRequestId = requestId;
                        const myMealRequest = myMealRequests.find(m => m.id === mealRequestId);
                        if (myMealRequest) {
                            const otherFingerprints = await fingerprintService.getAll();
                            const matchingFingerprint = otherFingerprints.find(f => 
                                f.userId === otherUserId && 
                                f.status === 'active' &&
                                f.mealType === myMealRequest.mealType
                            );
                            if (matchingFingerprint) {
                                fingerprintId = matchingFingerprint.id;
                            }
                        }
                    }
                } else {
                    // Try to find matching requests automatically
                    const otherMealRequests = await mealRequestService.getAll();
                    const otherFingerprints = await fingerprintService.getAll();
                    
                    const otherActiveMealRequests = otherMealRequests.filter(m => 
                        m.userId === otherUserId && m.status === 'active'
                    );
                    const otherActiveFingerprints = otherFingerprints.filter(f => 
                        f.userId === otherUserId && f.status === 'active'
                    );

                    // Case 1: I have fingerprint, other has meal request
                    if (myFingerprints.length > 0 && otherActiveMealRequests.length > 0) {
                        const myFingerprint = myFingerprints.find(f => 
                            otherActiveMealRequests.some(m => m.mealType === f.mealType)
                        );
                        if (myFingerprint) {
                            const otherRequest = otherActiveMealRequests.find(m => 
                                m.mealType === myFingerprint.mealType
                            );
                            if (otherRequest) {
                                fingerprintId = myFingerprint.id;
                                mealRequestId = otherRequest.id;
                            }
                        }
                    }
                    
                    // Case 2: I have meal request, other has fingerprint
                    if (!fingerprintId && myMealRequests.length > 0 && otherActiveFingerprints.length > 0) {
                        const myMealRequest = myMealRequests.find(m => 
                            otherActiveFingerprints.some(f => f.mealType === m.mealType)
                        );
                        if (myMealRequest) {
                            const otherFingerprint = otherActiveFingerprints.find(f => 
                                f.mealType === myMealRequest.mealType
                            );
                            if (otherFingerprint) {
                                fingerprintId = otherFingerprint.id;
                                mealRequestId = myMealRequest.id;
                            }
                        }
                    }
                }

                if (!fingerprintId || !mealRequestId) {
                    alert('Eşleşme oluşturmak için aktif bir parmak izi ve yemek talebi gerekiyor. Lütfen ana sayfadan ilgili talepleri oluşturun.');
                    sendBtn.disabled = false;
                    sendBtn.textContent = originalText;
                    return;
                }

                console.log('Creating match with fingerprintId:', fingerprintId, 'mealRequestId:', mealRequestId);
                const result = await matchService.createMatch(fingerprintId, mealRequestId);
                console.log('Match created:', result);
                if (result) {
                    alert('Eşleşme talebi başarıyla gönderildi!');
                    // Reload page to show updated status
                    window.location.reload();
                } else {
                    alert('Eşleşme oluşturulamadı. Lütfen taleplerin aktif olduğundan emin olun.');
                }
            } catch (error) {
                console.error('Create match error:', error);
                const errorMessage = error.message || 'Eşleşme talebi gönderilemedi';
                alert(errorMessage);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = originalText;
            }
        }

        // Event listeners
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
        document.getElementById('sendMatchRequestBtn').addEventListener('click', sendMatchRequest);

        // Enter key to send
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Start polling for new messages
        stopPolling = chatService.startPolling(otherUserId, (messages) => {
            renderMessages(messages);
        }, 2000);

        // Initial load
        loadUserRequests();
        loadMessages();

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (stopPolling) stopPolling();
        });
    </script>
}

