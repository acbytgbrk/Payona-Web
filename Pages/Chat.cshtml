@page
@model ChatModel
@{
    ViewData["Title"] = "Sohbet - Payona";
}

<style>
    /* === Sohbet SayfasÄ± Ã–zel Stilleri === */
    .chat-wrapper {
        max-width: 900px;
        margin: 0 auto;
        /* Navbar (70px) + Footer (auto) boÅŸluÄŸu iÃ§in hesaplama */
        height: calc(100vh - 100px); 
        padding-bottom: 1rem;
    }

    .chat-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        box-shadow: 0 5px 25px var(--shadow-color);
        border-radius: 20px;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Header */
    .chat-header {
        padding: 1rem 1.5rem;
        background: var(--bg-card);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .chat-user-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .user-avatar {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
    }

    .user-details h2 {
        font-size: 1.1rem;
        margin: 0;
        color: var(--text-main);
    }

    .user-status {
        font-size: 0.85rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .status-dot { width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; }

    /* Messages Area */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background-color: var(--bg-body);
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    /* Balonlar */
    .message-wrapper {
        display: flex;
        flex-direction: column;
        max-width: 70%;
        animation: fadeIn 0.3s ease-out;
        margin-bottom: 0.75rem;
    }

    .message-sent {
        align-self: flex-end;
        align-items: flex-end;
    }

    .message-received {
        align-self: flex-start;
        align-items: flex-start;
    }

    /* Mesaj BalonlarÄ± - Unified Component */
    .message-bubble {
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 0.95rem;
        line-height: 1.5;
        position: relative;
        word-wrap: break-word;
        max-width: 100%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin: 0;
        /* VarsayÄ±lan stilleri sÄ±fÄ±rla */
        background: none;
        background-color: transparent;
        color: inherit;
        border: none;
    }

    /* Outgoing (GÃ¶nderilen) - Her iki modda aynÄ± - Global CSS override */
    /* main.css'teki .message-sent stilini tamamen override et */
    .chat-wrapper .chat-card .chat-messages .message-wrapper.message-sent .message-bubble.outgoing,
    .chat-card .chat-messages .message-wrapper.message-sent .message-bubble.outgoing,
    .chat-messages .message-wrapper.message-sent .message-bubble.outgoing,
    .message-wrapper.message-sent .message-bubble.outgoing,
    .message-bubble.outgoing {
        background-color: #FF6B6B !important;
        background: #FF6B6B !important;
        background-image: none !important;
        color: #FFFFFF !important;
        border-bottom-right-radius: 4px;
        border: none !important;
    }
    
    /* main.css'teki .message-sent class'Ä±nÄ± override et (eÄŸer doÄŸrudan uygulanÄ±rsa) */
    .chat-wrapper .chat-card .chat-messages .message-sent.message-bubble,
    .chat-card .chat-messages .message-sent.message-bubble,
    .chat-messages .message-sent.message-bubble {
        background-color: #FF6B6B !important;
        background: #FF6B6B !important;
        background-image: none !important;
        color: #FFFFFF !important;
    }

    /* Incoming (AlÄ±nan) - Light Mode - Global CSS override */
    /* main.css'teki .message-received stilini tamamen override et */
    .chat-wrapper .chat-card .chat-messages .message-wrapper.message-received .message-bubble.incoming,
    .chat-card .chat-messages .message-wrapper.message-received .message-bubble.incoming,
    .chat-messages .message-wrapper.message-received .message-bubble.incoming,
    .message-wrapper.message-received .message-bubble.incoming,
    .message-bubble.incoming {
        background-color: #F1F1F1 !important;
        background: #F1F1F1 !important;
        background-image: none !important;
        color: #2D3436 !important;
        border: 1px solid var(--border-color) !important;
        border-bottom-left-radius: 4px;
    }
    
    /* main.css'teki .message-received class'Ä±nÄ± override et (eÄŸer doÄŸrudan uygulanÄ±rsa) */
    .chat-wrapper .chat-card .chat-messages .message-received.message-bubble,
    .chat-card .chat-messages .message-received.message-bubble,
    .chat-messages .message-received.message-bubble {
        background-color: #F1F1F1 !important;
        background: #F1F1F1 !important;
        background-image: none !important;
        color: #2D3436 !important;
    }
    
    /* Incoming (AlÄ±nan) - Dark Mode - Global CSS override */
    body.dark-theme .chat-wrapper .chat-card .chat-messages .message-wrapper.message-received .message-bubble.incoming,
    body.dark-theme .chat-card .chat-messages .message-wrapper.message-received .message-bubble.incoming,
    body.dark-theme .chat-messages .message-wrapper.message-received .message-bubble.incoming,
    body.dark-theme .message-wrapper.message-received .message-bubble.incoming,
    body.dark-theme .message-bubble.incoming {
        background-color: #1E1E1E !important;
        background: #1E1E1E !important;
        background-image: none !important;
        color: #ECF0F1 !important;
        border-color: #2c3e50 !important;
    }
    
    /* main.css'teki .message-received class'Ä±nÄ± dark mode'da override et */
    body.dark-theme .chat-wrapper .chat-card .chat-messages .message-received.message-bubble,
    body.dark-theme .chat-card .chat-messages .message-received.message-bubble,
    body.dark-theme .chat-messages .message-received.message-bubble {
        background-color: #1E1E1E !important;
        background: #1E1E1E !important;
        background-image: none !important;
        color: #ECF0F1 !important;
    }

    .message-time {
        font-size: 0.7rem;
        margin-top: 4px;
        opacity: 0.7;
        padding: 0 4px;
    }

    .message-sent .message-time { 
        color: rgba(255, 255, 255, 0.85); 
        text-align: right; 
    }
    .message-received .message-time { 
        color: var(--text-secondary); 
        text-align: left;
    }

    /* Input Area */
    .chat-input-area {
        padding: 1rem 1.5rem;
        background: var(--bg-card);
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-shrink: 0;
    }

    #messageInput {
        flex: 1;
        padding: 12px 20px;
        border-radius: 30px;
        border: 2px solid var(--border-color);
        background: var(--bg-input);
        color: var(--text-main);
        outline: none;
        transition: all 0.3s;
    }

    #messageInput:focus {
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
    }

    .btn-send {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: none;
        background: var(--brand-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
    }

    .btn-send:hover {
        background: var(--brand-dark);
        transform: scale(1.05);
    }

    .btn-match {
        padding: 8px 16px;
        border-radius: 20px;
        background: var(--brand-secondary);
        color: white;
        border: none;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
    }
    
    .btn-match:hover {
        filter: brightness(1.1);
        transform: translateY(-2px);
    }

    @@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @@keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @@keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }

</style>

<div class="chat-wrapper">
    <div class="chat-card">
        <!-- HEADER -->
        <div class="chat-header">
            <div class="chat-user-info">
                <div class="user-avatar" id="avatarInitial">U</div>
                <div class="user-details">
                    <h2 id="chatUserName">YÃ¼kleniyor...</h2>
                    <div class="user-status" id="chatUserInfo">
                        <span class="status-dot"></span> Ã‡evrimiÃ§i
                    </div>
                </div>
            </div>
            
            <div style="display:flex; align-items:center; gap:10px;">
                <div id="matchStatusBadge" style="display:none; padding:6px 12px; background:var(--brand-secondary); color:white; border-radius:15px; font-size:0.85rem; font-weight:600;">
                    <i class="fas fa-check-circle"></i> EÅŸleÅŸti
                </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <div id="matchStatusBadge" style="display:none; padding:6px 12px; background:var(--brand-secondary); color:white; border-radius:15px; font-size:0.85rem; font-weight:600;">
                    <i class="fas fa-check-circle"></i> EÅŸleÅŸti
                </div>
                <button class="btn-match" id="sendMatchRequestBtn">
                    <i class="fas fa-handshake"></i> EÅŸleÅŸ
                </button>
            </div>
        </div>
        </div>

        <!-- MESSAGES -->
        <div class="chat-messages" id="chatMessages">
            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p style="margin-top: 1rem;">Sohbet yÃ¼kleniyor...</p>
            </div>
        </div>

        <!-- INPUT -->
        <div class="chat-input-area">
            <input type="text" id="messageInput" placeholder="Bir mesaj yazÄ±n..." autocomplete="off">
            <button class="btn-send" id="sendMessageBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script type="module">
        import { authService } from '/js/modules/auth.js';
        import { chatService } from '/js/modules/chat.js';
        import { matchService } from '/js/modules/match.js';
        import { fingerprintService } from '/js/modules/fingerprint.js';
        import { mealRequestService } from '/js/modules/mealRequest.js';

        // 1. GÃœVENLÄ°K
        if (!authService.isAuthenticated()) {
            window.location.href = '/';
        }
        
        // 2. URL PARAMETRELERÄ°
        const urlParams = new URLSearchParams(window.location.search);
        const otherUserIdParam = urlParams.get('userId');
        const otherUserName = urlParams.get('userName');
        const requestId = urlParams.get('requestId');
        const requestType = urlParams.get('requestType');

        if (!otherUserIdParam) window.location.href = '/Dashboard';

        const currentUser = authService.getCurrentUser();
        const otherUserId = otherUserIdParam;
        
        let stopPolling = null;
        let myFingerprints = [];
        let myMealRequests = [];

        // 3. UI BAÅžLATMA
        const nameEl = document.getElementById('chatUserName');
        const infoEl = document.getElementById('chatUserInfo');
        const avatarEl = document.getElementById('avatarInitial');

        if (otherUserName) {
            nameEl.textContent = otherUserName;
            avatarEl.textContent = otherUserName.charAt(0).toUpperCase();
            infoEl.innerHTML = '<span class="status-dot"></span> Åžu an aktif'; 
        } else {
            nameEl.textContent = "KullanÄ±cÄ±";
        }

        // 4. MESAJLARI YÃœKLE
        async function loadMessages() {
            try {
                const messages = await chatService.getConversation(otherUserId);
                renderMessages(messages);
            } catch (error) {
                console.error(error);
                document.getElementById('chatMessages').innerHTML = 
                    `<p style="text-align:center; color:#e74c3c;">Mesajlar yÃ¼klenemedi.</p>`;
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('chatMessages');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; color:var(--text-secondary); margin-top:2rem;">
                        <i class="far fa-comments fa-3x" style="opacity:0.3; margin-bottom:1rem;"></i>
                        <p>HenÃ¼z mesaj yok. Ä°lk mesajÄ± sen at! ðŸ‘‹</p>
                    </div>`;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isSent = msg.senderId === currentUser.id;
                const timeStr = new Date(msg.createdAt).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                const bubbleClass = isSent ? 'outgoing' : 'incoming';

                return `
                    <div class="message-wrapper ${isSent ? 'message-sent' : 'message-received'}">
                        <div class="message-bubble ${bubbleClass}">
                            ${msg.content}
                        </div>
                        <div class="message-time">
                            ${timeStr}
                        </div>
                    </div>
                `;
            }).join('');
            
            // En alta kaydÄ±r
            container.scrollTop = container.scrollHeight;
        }

        // 5. MESAJ GÃ–NDERME
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content) return;

            const sendBtn = document.getElementById('sendMessageBtn');
            const originalIcon = sendBtn.innerHTML;

            // Loading state
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                await chatService.sendMessage(otherUserId, content);
                input.value = '';
                // MesajlarÄ± yeniden yÃ¼kle ve render et
                await loadMessages();
                // Scroll'u en alta kaydÄ±r
                const messagesContainer = document.getElementById('chatMessages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            } catch (error) {
                alert('Mesaj gÃ¶nderilemedi: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalIcon;
                // Focus tekrar input'a gelsin
                input.focus();
            }
        }

        // 6. EÅžLEÅžME TALEBÄ° MANTIÄžI (Match Request)
        async function loadUserRequests() {
            try {
                const [fingerprints, mealRequests] = await Promise.all([
                    fingerprintService.getMy(),
                    mealRequestService.getMy()
                ]);
                myFingerprints = fingerprints.filter(f => f.status === 'active');
                myMealRequests = mealRequests.filter(m => m.status === 'active');
            } catch(e) { console.error(e); }
        }

        async function sendMatchRequest() {
            if (!confirm('EÅŸleÅŸme teklifi gÃ¶ndermek istiyor musun? Eksik talepler otomatik oluÅŸturulacak.')) return;
            const btn = document.getElementById('sendMatchRequestBtn');
            const originalContent = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Bekleyin...';

            try {
                // Ã–ÄŸÃ¼n tipini belirle (varsa requestId'den, yoksa varsayÄ±lan)
                let mealType = 'lunch';
                if (requestId && requestType) {
                    if (requestType === 'fingerprint') {
                        const myFp = myFingerprints.find(f => f.id === requestId);
                        if (myFp) mealType = myFp.mealType;
                    } else {
                        const myMr = myMealRequests.find(m => m.id === requestId);
                        if (myMr) mealType = myMr.mealType;
                    }
                }

                // Otomatik eÅŸleÅŸme - backend eksik talepleri otomatik oluÅŸturacak
                const result = await matchService.createAutoMatch(otherUserId, mealType);
                
                if (result) {
                    // Butonu gÃ¼ncelle
                    btn.innerHTML = '<i class="fas fa-check"></i> EÅŸleÅŸme OluÅŸturuldu';
                    btn.style.background = 'var(--brand-secondary)';
                    btn.disabled = true;
                    
                    // BaÅŸarÄ± mesajÄ± gÃ¶ster
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = 'position:fixed; top:20px; right:20px; background:#43e97b; color:white; padding:1rem 1.5rem; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.2); z-index:3000; animation:slideIn 0.3s ease-out;';
                    successMsg.innerHTML = '<i class="fas fa-check-circle"></i> EÅŸleÅŸme baÅŸarÄ±yla oluÅŸturuldu!';
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => {
                        successMsg.style.animation = 'slideOut 0.3s ease-out';
                        setTimeout(() => successMsg.remove(), 300);
                    }, 3000);
                    
                    // Talepleri yeniden yÃ¼kle ve eÅŸleÅŸme durumunu kontrol et
                    await loadUserRequests();
                    await checkMatchStatus();
                } else {
                    throw new Error('EÅŸleÅŸme oluÅŸturulamadÄ±.');
                }

            } catch (error) {
                alert('Hata: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        // EVENT LISTENERS
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        document.getElementById('sendMatchRequestBtn').addEventListener('click', sendMatchRequest);

        // 7. EÅžLEÅžME DURUMUNU KONTROL ET
        async function checkMatchStatus() {
            try {
                const matches = await matchService.getMyMatches();
                const match = matches.find(m => 
                    (m.giverId === currentUser.id && m.receiverId === otherUserId) ||
                    (m.receiverId === currentUser.id && m.giverId === otherUserId)
                );
                
                const badge = document.getElementById('matchStatusBadge');
                const btn = document.getElementById('sendMatchRequestBtn');
                
                if (match) {
                    badge.style.display = 'block';
                    btn.style.display = 'none';
                } else {
                    badge.style.display = 'none';
                    btn.style.display = 'flex';
                }
            } catch (error) {
                console.error('Error checking match status:', error);
            }
        }

        // BAÅžLATMA
        loadUserRequests();
        loadMessages();
        checkMatchStatus();
        
        // Polling (CanlÄ± Sohbet)
        stopPolling = chatService.startPolling(otherUserId, (msgs) => renderMessages(msgs), 2000);

        window.addEventListener('beforeunload', () => {
            if (stopPolling) stopPolling();
        });

    </script>
}