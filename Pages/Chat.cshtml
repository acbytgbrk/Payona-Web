@page
@model ChatModel
@{
    ViewData["Title"] = "Sohbet - Payona";
}

<style>
    /* === Sohbet SayfasÄ± Ã–zel Stilleri === */
    .chat-wrapper {
        max-width: 900px;
        margin: 0 auto;
        /* Navbar (70px) + Footer (auto) boÅŸluÄŸu iÃ§in hesaplama */
        height: calc(100vh - 100px); 
        padding-bottom: 1rem;
    }

    .chat-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        box-shadow: 0 5px 25px var(--shadow-color);
        border-radius: 20px;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    /* Header */
    .chat-header {
        padding: 1rem 1.5rem;
        background: var(--bg-card);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .chat-user-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .user-avatar {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
    }

    .user-details h2 {
        font-size: 1.1rem;
        margin: 0;
        color: var(--text-main);
    }

    .user-status {
        font-size: 0.85rem;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .status-dot { width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; }

    /* Messages Area */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        background-color: var(--bg-body); /* ArkaplanÄ± hafif farklÄ± olsun */
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    /* Balonlar */
    .message-wrapper {
        display: flex;
        flex-direction: column;
        max-width: 70%;
        animation: fadeIn 0.3s ease-out;
    }

    .message-sent {
        align-self: flex-end;
        align-items: flex-end;
    }

    .message-received {
        align-self: flex-start;
        align-items: flex-start;
    }

    .message-bubble {
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 0.95rem;
        line-height: 1.4;
        position: relative;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .message-sent .message-bubble {
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-dark));
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message-received .message-bubble {
        background: var(--bg-input);
        color: var(--text-main);
        border: 1px solid var(--border-color);
        border-bottom-left-radius: 4px;
    }

    .message-time {
        font-size: 0.7rem;
        margin-top: 4px;
        opacity: 0.7;
    }

    .message-sent .message-time { color: var(--text-secondary); text-align: right; }
    .message-received .message-time { color: var(--text-secondary); }

    /* Input Area */
    .chat-input-area {
        padding: 1rem 1.5rem;
        background: var(--bg-card);
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-shrink: 0;
    }

    #messageInput {
        flex: 1;
        padding: 12px 20px;
        border-radius: 30px;
        border: 2px solid var(--border-color);
        background: var(--bg-input);
        color: var(--text-main);
        outline: none;
        transition: all 0.3s;
    }

    #messageInput:focus {
        border-color: var(--brand-primary);
        box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
    }

    .btn-send {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: none;
        background: var(--brand-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
    }

    .btn-send:hover {
        background: var(--brand-dark);
        transform: scale(1.05);
    }

    .btn-match {
        padding: 8px 16px;
        border-radius: 20px;
        background: var(--brand-secondary);
        color: white;
        border: none;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s;
    }
    
    .btn-match:hover {
        filter: brightness(1.1);
        transform: translateY(-2px);
    }

    @@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

</style>

<div class="chat-wrapper">
    <div class="chat-card">
        <!-- HEADER -->
        <div class="chat-header">
            <div class="chat-user-info">
                <div class="user-avatar" id="avatarInitial">U</div>
                <div class="user-details">
                    <h2 id="chatUserName">YÃ¼kleniyor...</h2>
                    <div class="user-status" id="chatUserInfo">
                        <span class="status-dot"></span> Ã‡evrimiÃ§i
                    </div>
                </div>
            </div>
            
            <button class="btn-match" id="sendMatchRequestBtn">
                <i class="fas fa-handshake"></i> EÅŸleÅŸ
            </button>
        </div>

        <!-- MESSAGES -->
        <div class="chat-messages" id="chatMessages">
            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p style="margin-top: 1rem;">Sohbet yÃ¼kleniyor...</p>
            </div>
        </div>

        <!-- INPUT -->
        <div class="chat-input-area">
            <input type="text" id="messageInput" placeholder="Bir mesaj yazÄ±n..." autocomplete="off">
            <button class="btn-send" id="sendMessageBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script type="module">
        import { authService } from '/js/modules/auth.js';
        import { chatService } from '/js/modules/chat.js';
        import { matchService } from '/js/modules/match.js';
        import { fingerprintService } from '/js/modules/fingerprint.js';
        import { mealRequestService } from '/js/modules/mealRequest.js';

        // 1. GÃœVENLÄ°K
        if (!authService.isAuthenticated()) {
            window.location.href = '/';
        }
        
        // 2. URL PARAMETRELERÄ°
        const urlParams = new URLSearchParams(window.location.search);
        const otherUserIdParam = urlParams.get('userId');
        const otherUserName = urlParams.get('userName');
        const requestId = urlParams.get('requestId');
        const requestType = urlParams.get('requestType');

        if (!otherUserIdParam) window.location.href = '/Dashboard';

        const currentUser = authService.getCurrentUser();
        const otherUserId = otherUserIdParam;
        
        let stopPolling = null;
        let myFingerprints = [];
        let myMealRequests = [];

        // 3. UI BAÅžLATMA
        const nameEl = document.getElementById('chatUserName');
        const infoEl = document.getElementById('chatUserInfo');
        const avatarEl = document.getElementById('avatarInitial');

        if (otherUserName) {
            nameEl.textContent = otherUserName;
            avatarEl.textContent = otherUserName.charAt(0).toUpperCase();
            infoEl.innerHTML = '<span class="status-dot"></span> Åžu an aktif'; 
        } else {
            nameEl.textContent = "KullanÄ±cÄ±";
        }

        // 4. MESAJLARI YÃœKLE
        async function loadMessages() {
            try {
                const messages = await chatService.getConversation(otherUserId);
                renderMessages(messages);
            } catch (error) {
                console.error(error);
                document.getElementById('chatMessages').innerHTML = 
                    `<p style="text-align:center; color:#e74c3c;">Mesajlar yÃ¼klenemedi.</p>`;
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('chatMessages');
            
            if (!messages || messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; color:var(--text-secondary); margin-top:2rem;">
                        <i class="far fa-comments fa-3x" style="opacity:0.3; margin-bottom:1rem;"></i>
                        <p>HenÃ¼z mesaj yok. Ä°lk mesajÄ± sen at! ðŸ‘‹</p>
                    </div>`;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isSent = msg.senderId === currentUser.id;
                const timeStr = new Date(msg.createdAt).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="message-wrapper ${isSent ? 'message-sent' : 'message-received'}">
                        <div class="message-bubble">
                            ${msg.content}
                        </div>
                        <div class="message-time">
                            ${timeStr}
                        </div>
                    </div>
                `;
            }).join('');
            
            // En alta kaydÄ±r
            container.scrollTop = container.scrollHeight;
        }

        // 5. MESAJ GÃ–NDERME
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content) return;

            const sendBtn = document.getElementById('sendMessageBtn');
            const originalIcon = sendBtn.innerHTML;

            // Loading state
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                await chatService.sendMessage(otherUserId, content);
                input.value = '';
                await loadMessages(); 
            } catch (error) {
                alert('Mesaj gÃ¶nderilemedi: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalIcon;
                // Focus tekrar input'a gelsin
                input.focus();
            }
        }

        // 6. EÅžLEÅžME TALEBÄ° MANTIÄžI (Match Request)
        async function loadUserRequests() {
            try {
                const [fingerprints, mealRequests] = await Promise.all([
                    fingerprintService.getMy(),
                    mealRequestService.getMy()
                ]);
                myFingerprints = fingerprints.filter(f => f.status === 'active');
                myMealRequests = mealRequests.filter(m => m.status === 'active');
            } catch(e) { console.error(e); }
        }

        async function sendMatchRequest() {
            if (!confirm('EÅŸleÅŸme teklifi gÃ¶ndermek istiyor musun?')) return;
            const btn = document.getElementById('sendMatchRequestBtn');
            const originalContent = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Bekleyin...';

            try {
                let fId = null, mId = null;

                // URL'den geldiyse
                if (requestId && requestType) {
                    if (requestType === 'fingerprint') {
                        // Benim fingerprint'im, karÅŸÄ± tarafÄ±n meal request'ini bul
                        fId = requestId;
                        const others = await mealRequestService.getAll();
                        const match = others.find(m => m.userId === otherUserId && m.status === 'active');
                        if (match) {
                            mId = match.id;
                        } else {
                            throw new Error('KarÅŸÄ± tarafta aktif yemek alma talebi bulunamadÄ±.');
                        }
                    } else if (requestType === 'mealRequest') {
                        // Benim meal request'im, karÅŸÄ± tarafÄ±n fingerprint'ini bul
                        mId = requestId;
                        const others = await fingerprintService.getAll();
                        const match = others.find(f => f.userId === otherUserId && f.status === 'active');
                        if (match) {
                            fId = match.id;
                        } else {
                            throw new Error('KarÅŸÄ± tarafta aktif yemek verme talebi bulunamadÄ±.');
                        }
                    }
                } else {
                    // URL yoksa otomatik bulmaya Ã§alÄ±ÅŸ
                    // Benim aktif taleplerim
                    const myActiveFPs = myFingerprints.filter(f => f.status === 'active');
                    const myActiveMRs = myMealRequests.filter(m => m.status === 'active');
                    
                    // KarÅŸÄ± tarafÄ±n aktif talepleri
                    const [othersFPs, othersMRs] = await Promise.all([
                        fingerprintService.getAll(),
                        mealRequestService.getAll()
                    ]);
                    
                    const otherFPs = othersFPs.filter(f => f.userId === otherUserId && f.status === 'active');
                    const otherMRs = othersMRs.filter(m => m.userId === otherUserId && m.status === 'active');
                    
                    // EÅŸleÅŸme bul: Benim fingerprint'im + karÅŸÄ± tarafÄ±n meal request'i
                    if (myActiveFPs.length > 0 && otherMRs.length > 0) {
                        fId = myActiveFPs[0].id;
                        mId = otherMRs[0].id;
                    }
                    // Veya benim meal request'im + karÅŸÄ± tarafÄ±n fingerprint'i
                    else if (myActiveMRs.length > 0 && otherFPs.length > 0) {
                        mId = myActiveMRs[0].id;
                        fId = otherFPs[0].id;
                    } else {
                        throw new Error('EÅŸleÅŸme iÃ§in uygun aktif talepler bulunamadÄ±.');
                    }
                }

                if (!fId || !mId) {
                    throw new Error('EÅŸleÅŸme iÃ§in gerekli bilgiler eksik.');
                }

                // Match oluÅŸtur
                const result = await matchService.createMatch(fId, mId);
                if (result) {
                    alert('EÅŸleÅŸme baÅŸarÄ±yla oluÅŸturuldu!');
                    // Butonu gÃ¼ncelle
                    btn.innerHTML = '<i class="fas fa-check"></i> EÅŸleÅŸme OluÅŸturuldu';
                    btn.style.background = 'var(--brand-secondary)';
                    btn.disabled = true;
                } else {
                    throw new Error('EÅŸleÅŸme oluÅŸturulamadÄ±.');
                }

            } catch (error) {
                alert('Hata: ' + error.message);
            } finally {
                if (btn.innerHTML.includes('Bekleyin')) {
                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                }
            }
        }

        // EVENT LISTENERS
        document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        document.getElementById('sendMatchRequestBtn').addEventListener('click', sendMatchRequest);

        // BAÅžLATMA
        loadUserRequests();
        loadMessages();
        
        // Polling (CanlÄ± Sohbet)
        stopPolling = chatService.startPolling(otherUserId, (msgs) => renderMessages(msgs), 2000);

        window.addEventListener('beforeunload', () => {
            if (stopPolling) stopPolling();
        });

    </script>
}