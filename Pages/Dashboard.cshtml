@page
@model DashboardModel
@{
    ViewData["Title"] = "Ana Sayfa - Payona";
}

<!-- Ä°con KÃ¼tÃ¼phanesi (Remix Icon) -->
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <!-- KullanÄ±cÄ± AdÄ± GÃ¼ncellemesi (ID eklendi ve JS ile doldurulacak) -->
        <h1>HoÅŸgeldin, <span id="welcomeName">@(User.Identity?.Name ?? "Ã–ÄŸrenci")</span> ğŸ‘‹</h1>
        
        <div class="flex gap-2">
            <!-- Verme Butonu Ä°conu -->
            <button class="btn btn-primary" id="createGiveBtn" data-type="give" style="display: flex; align-items: center; gap: 8px;">
                <i class="ri-hand-heart-fill"></i> Verme Talebi OluÅŸtur
            </button>
            <!-- Alma Butonu Ä°conu -->
            <button class="btn btn-secondary" id="createTakeBtn" data-type="take" style="display: flex; align-items: center; gap: 8px;">
                <i class="ri-restaurant-fill"></i> Alma Talebi OluÅŸtur
            </button>
        </div>
    </div>

    <!-- Canvas Visualization -->
    <div class="card mb-4">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h2 class="card-title mb-0">Aktivite Ã–zeti</h2>
            <select id="periodSelect" class="form-select" style="width: auto; padding: 0.5rem;">
                <option value="day">GÃ¼n</option>
                <option value="week" selected>Hafta</option>
                <option value="month">Ay</option>
                <option value="year">YÄ±l</option>
            </select>
        </div>
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem; flex: 1; min-width: 150px;">
                <div style="font-size: 0.875rem; color: var(--text-secondary);">OluÅŸturulan Talep</div>
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-primary);" id="totalRequestsCreated">0</div>
            </div>
            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem; flex: 1; min-width: 150px;">
                <div style="font-size: 0.875rem; color: var(--text-secondary);">Kabul Edilen EÅŸleÅŸme</div>
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-secondary);" id="totalMatchesAccepted">0</div>
            </div>
            <div style="padding: 0.75rem; background: var(--bg-secondary); border-radius: 0.5rem; flex: 1; min-width: 150px;">
                <div style="font-size: 0.875rem; color: var(--text-secondary);">Toplam EÅŸleÅŸme</div>
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-primary);" id="totalMatchesCreated">0</div>
            </div>
        </div>
        <canvas id="activityCanvas" width="800" height="200" style="width: 100%; max-width: 800px; height: 200px; border-radius: 0.5rem; background: var(--bg-secondary);"></canvas>
    </div>

    <!-- My Requests Section -->
    <section class="mb-4">
        <!-- Taleplerim Ä°conu -->
        <h2 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 10px;">
            <i class="ri-user-star-line" style="color: var(--accent-primary);"></i> Taleplerim
        </h2>
        <div id="myRequests" class="grid grid-cols-1 gap-4">
            <div class="text-center" style="padding: 2rem; color: var(--text-secondary);">
                <div class="spinner" style="margin: 0 auto;"></div>
                <p class="mt-2">YÃ¼kleniyor...</p>
            </div>
        </div>
    </section>

    <!-- Other Students' Requests Section -->
    <section>
        <!-- DiÄŸer Talepler Ä°conu -->
        <h2 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 10px;">
            <i class="ri-community-line" style="color: var(--accent-secondary);"></i> DiÄŸer Ã–ÄŸrencilerin Talepleri
        </h2>
        <div id="otherRequests" class="grid grid-cols-1 gap-4">
            <div class="text-center" style="padding: 2rem; color: var(--text-secondary);">
                <div class="spinner" style="margin: 0 auto;"></div>
                <p class="mt-2">YÃ¼kleniyor...</p>
            </div>
        </div>
    </section>
</div>

<!-- Create Request Modal -->
<div id="createModal" class="modal-overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modalTitle">Talep OluÅŸtur</h2>
            <button class="modal-close" id="closeCreateModalBtn">&times;</button>
        </div>
        <form id="createRequestForm">
            <input type="hidden" id="requestType" />
            <div class="form-group">
                <label class="form-label" for="mealType">Ã–ÄŸÃ¼n TÃ¼rÃ¼</label>
                <select id="mealType" class="form-select" required>
                    <option value="">Ã–ÄŸÃ¼n SeÃ§iniz</option>
                    <option value="lunch">Ã–ÄŸle YemeÄŸi</option>
                    <option value="dinner">AkÅŸam YemeÄŸi</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="preferredDate">Tercih Edilen Tarih (Ä°steÄŸe BaÄŸlÄ±)</label>
                <input type="date" id="preferredDate" class="form-input" />
            </div>
            <div class="form-group">
                <label class="form-label" for="preferredStartTime">BaÅŸlangÄ±Ã§ Saati (Ä°steÄŸe BaÄŸlÄ±)</label>
                <input type="time" id="preferredStartTime" class="form-input" />
            </div>
            <div class="form-group">
                <label class="form-label" for="preferredEndTime">BitiÅŸ Saati (Ä°steÄŸe BaÄŸlÄ±)</label>
                <input type="time" id="preferredEndTime" class="form-input" />
            </div>
            <div class="form-group">
                <label class="form-label" for="notes">Notlar (Ä°steÄŸe BaÄŸlÄ±)</label>
                <textarea id="notes" class="form-textarea" placeholder="Ek bilgiler..."></textarea>
            </div>
            <div id="createError" class="text-error hidden mb-2"></div>
            <div class="flex gap-2">
                <button type="submit" class="btn btn-primary" style="flex: 1;" id="submitCreateBtn">
                    <span class="btn-text">OluÅŸtur</span>
                    <span class="btn-loading hidden">OluÅŸturuluyor...</span>
                </button>
                <button type="button" class="btn btn-secondary" id="cancelCreateModalBtn">Ä°ptal</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
<script type="module">
    import { authService } from '/js/modules/auth.js';
    import { mealRequestService } from '/js/modules/mealRequest.js';
    import { fingerprintService } from '/js/modules/fingerprint.js';
    import { matchService } from '/js/modules/match.js';

    // Check authentication
    if (!authService.isAuthenticated()) {
        window.location.href = '/';
    }

    const user = authService.getCurrentUser();
    if (authService.requiresDormInfo()) {
        window.location.href = '/DormInfo';
    }

    // --- KULLANICI ADINI DÃœZELTME KODU ---
    // EÄŸer JS tarafÄ±nda kullanÄ±cÄ± ismi varsa, baÅŸlÄ±ktaki "Ã–ÄŸrenci" yazÄ±sÄ±nÄ± deÄŸiÅŸtir.
    if (user && user.name) {
        const welcomeSpan = document.getElementById('welcomeName');
        if (welcomeSpan) {
            welcomeSpan.textContent = user.name;
        }
    }
    // -------------------------------------

    let currentPeriod = 'week';
    let activityData = null;

    // --- VERÄ° GRUPLANDIRMA ---
    function aggregateData(dailyStats, period) {
        if (!dailyStats || dailyStats.length === 0) return [];
        if (period === 'day' || period === 'week') {
            return dailyStats;
        }

        const groupedData = {};

        dailyStats.forEach(stat => {
            const date = new Date(stat.date);
            let key;
            let label;
            let sortDate;

            if (period === 'month') {
                const dayOfMonth = date.getDate();
                const weekNum = Math.ceil(dayOfMonth / 7); 
                key = `week-${weekNum}`;
                label = `${weekNum}. Hafta`;
                sortDate = new Date(date.getFullYear(), date.getMonth(), (weekNum - 1) * 7 + 1);
            } else if (period === 'year') {
                const monthIndex = date.getMonth();
                key = `month-${monthIndex}`;
                sortDate = new Date(date.getFullYear(), monthIndex, 1);
                label = sortDate; 
            }

            if (!groupedData[key]) {
                groupedData[key] = {
                    date: sortDate, 
                    labelOverride: period === 'month' ? label : null,
                    requestsCreated: 0,
                    matchesCreated: 0,
                    matchesAccepted: 0
                };
            }

            groupedData[key].requestsCreated += stat.requestsCreated;
            groupedData[key].matchesCreated += stat.matchesCreated;
            groupedData[key].matchesAccepted += stat.matchesAccepted;
        });

        return Object.values(groupedData).sort((a, b) => new Date(a.date) - new Date(b.date));
    }

    // Load activity stats
    async function loadActivityStats(period = 'week') {
        try {
            const stats = await matchService.getActivityStats(period);
            activityData = stats;
            updateStatsDisplay(stats);
            const processedData = aggregateData(stats.dailyStats, period);
            drawChart(processedData, period); 
        } catch (error) {
            console.error('Error loading activity stats:', error);
        }
    }

    function updateStatsDisplay(stats) {
        document.getElementById('totalRequestsCreated').textContent = stats.totalRequestsCreated || 0;
        document.getElementById('totalMatchesAccepted').textContent = stats.totalMatchesAccepted || 0;
        document.getElementById('totalMatchesCreated').textContent = stats.totalMatchesCreated || 0;
    }

    // Initialize Canvas
    function initCanvas() {
        const canvas = document.getElementById('activityCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = 200;

        window.drawChart = function(dailyStats, period) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!dailyStats || dailyStats.length === 0) {
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('HenÃ¼z veri yok', canvas.width / 2, canvas.height / 2);
                return;
            }

            const padding = 40;
            const chartWidth = canvas.width - padding * 2;
            const chartHeight = canvas.height - padding * 2;
            
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border-color');
            ctx.lineWidth = 1;
            const dataPoints = dailyStats.length;
            const maxValue = Math.max(
                ...dailyStats.map(d => d.requestsCreated + d.matchesCreated + d.matchesAccepted),
                1
            );
            
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }
            
            for (let i = 0; i <= dataPoints; i++) {
                const x = padding + (chartWidth / dataPoints) * i;
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, canvas.height - padding);
                ctx.stroke();
            }
            
            const barWidth = chartWidth / dataPoints - 5;
            const colors = {
                requests: getComputedStyle(document.documentElement).getPropertyValue('--accent-primary'),
                matches: getComputedStyle(document.documentElement).getPropertyValue('--accent-secondary'),
                accepted: getComputedStyle(document.documentElement).getPropertyValue('--accent-secondary')
            };

            dailyStats.forEach((day, index) => {
                const x = padding + (chartWidth / dataPoints) * index + 2.5;
                const total = day.requestsCreated + day.matchesCreated + day.matchesAccepted;
                let currentY = canvas.height - padding;
                
                if (day.requestsCreated > 0) {
                    const height = (day.requestsCreated / maxValue) * chartHeight;
                    ctx.fillStyle = colors.requests;
                    ctx.fillRect(x, currentY - height, barWidth, height);
                    currentY -= height;
                }
                
                if (day.matchesCreated > 0) {
                    const height = (day.matchesCreated / maxValue) * chartHeight;
                    ctx.fillStyle = colors.matches;
                    ctx.fillRect(x, currentY - height, barWidth, height);
                    currentY -= height;
                }
                
                if (day.matchesAccepted > 0) {
                    const height = (day.matchesAccepted / maxValue) * chartHeight;
                    ctx.fillStyle = colors.accepted;
                    ctx.globalAlpha = 0.7;
                    ctx.fillRect(x, currentY - height, barWidth, height);
                    ctx.globalAlpha = 1.0;
                }
            });
            
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'center';
            dailyStats.forEach((day, index) => {
                const x = padding + (chartWidth / dataPoints) * index + (chartWidth / dataPoints) / 2;
                const date = new Date(day.date);
                let label = '';

                if (day.labelOverride) {
                    label = day.labelOverride;
                } else {
                    if (period === 'day') {
                        label = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                    } else if (period === 'week') {
                        label = date.toLocaleDateString('tr-TR', { weekday: 'short' });
                    } else if (period === 'year') {
                        label = date.toLocaleDateString('tr-TR', { month: 'short' });
                    }
                }
                ctx.fillText(label, x, canvas.height - 10);
            });
        };
        
        window.addEventListener('resize', () => {
            canvas.width = canvas.offsetWidth;
            if (activityData) {
                const processedData = aggregateData(activityData.dailyStats, currentPeriod);
                drawChart(processedData, currentPeriod);
            }
        });
    }

    initCanvas();

    document.getElementById('periodSelect').addEventListener('change', (e) => {
        currentPeriod = e.target.value;
        loadActivityStats(currentPeriod);
    });

    loadActivityStats('week');

    async function loadRequests() {
        try {
            const [myMealRequests, allMealRequests, myFingerprints, allFingerprints] = await Promise.all([
                mealRequestService.getMy(),
                mealRequestService.getAll(),
                fingerprintService.getMy(),
                fingerprintService.getAll()
            ]);

            const user = authService.getCurrentUser();
            const myRequests = [
                ...myMealRequests.filter(req => req.status !== 'cancelled').map(req => ({ ...req, type: 'mealRequest' })),
                ...myFingerprints.filter(fp => fp.status !== 'cancelled').map(fp => ({ ...fp, type: 'fingerprint' }))
            ].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            const otherMealRequests = allMealRequests.filter(req => {
                if (req.userId === user.id) return false;
                if (req.status === 'cancelled' || req.status === 'matched') return false;
                if (user.dorm && req.userDorm) {
                    return req.userDorm === user.dorm;
                }
                return true; 
            }).map(req => ({ ...req, type: 'mealRequest' }));

            const otherFingerprints = allFingerprints.filter(fp => {
                if (fp.userId === user.id) return false;
                if (fp.status === 'cancelled' || fp.status === 'matched') return false;
                if (user.dorm && fp.userDorm) {
                    return fp.userDorm === user.dorm;
                }
                return true; 
            }).map(fp => ({ ...fp, type: 'fingerprint' }));

            const otherRequests = [...otherMealRequests, ...otherFingerprints]
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            renderRequests('myRequests', myRequests, true);
            renderRequests('otherRequests', otherRequests, false);
        } catch (error) {
            console.error('Error loading requests:', error);
            document.getElementById('myRequests').innerHTML =
                '<p class="text-error">Talepler yÃ¼klenemedi</p>';
            document.getElementById('otherRequests').innerHTML =
                '<p class="text-error">Talepler yÃ¼klenemedi</p>';
        }
    }

    function renderRequests(containerId, requests, isOwn) {
        const container = document.getElementById(containerId);
        if (!requests || requests.length === 0) {
            container.innerHTML = '<p style="color: var(--text-secondary);">Talep bulunamadÄ±</p>';
            return;
        }

        container.innerHTML = requests.map(request => {
            const isFingerprint = request.type === 'fingerprint';
            const isGive = isFingerprint; 
            const dateField = isFingerprint ? 'availableDate' : 'preferredDate';
            const startTimeField = isFingerprint ? 'startTime' : 'preferredStartTime';
            const endTimeField = isFingerprint ? 'endTime' : 'preferredEndTime';
            const notesField = isFingerprint ? 'description' : 'notes';
            return `
                <div class="card request-card"
                     data-user-id="${request.userId}"
                     data-user-name="${(request.userName || '').replace(/"/g, '&quot;')}"
                     data-request-id="${request.id}"
                     data-request-type="${request.type}">
                    <div class="flex justify-between items-center mb-2">
                        <span class="request-type ${isGive ? 'give' : 'take'}">
                            ${isGive ? 'ğŸ½ï¸ Verme' : 'ğŸ´ Alma'}
                        </span>
                        <span class="badge badge-primary">${request.status || 'active'}</span>
                    </div>
                    <p><strong>${request.userName || 'Bilinmeyen'}</strong> ${request.userGender ? `(${request.userGender})` : ''}</p>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        Ã–ÄŸÃ¼n: ${request.mealType === 'lunch' ? 'Ã–ÄŸle YemeÄŸi' : request.mealType === 'dinner' ? 'AkÅŸam YemeÄŸi' : request.mealType}
                    </p>
                    ${request[dateField] ? `<p style="color: var(--text-secondary); font-size: 0.9rem;">Tarih: ${new Date(request[dateField]).toLocaleDateString('tr-TR')}</p>` : ''}
                    ${request[startTimeField] && request[endTimeField] ?
                        `<p style="color: var(--text-secondary); font-size: 0.9rem;">Saat: ${request[startTimeField]} - ${request[endTimeField]}</p>` : ''}
                    ${request[notesField] ? `<p style="margin-top: 0.5rem;">${request[notesField]}</p>` : ''}
                    <p style="color: var(--text-tertiary); font-size: 0.85rem; margin-top: 0.5rem;">
                        ${new Date(request.createdAt).toLocaleString('tr-TR')}
                    </p>
                    ${isOwn ? `<button class="btn btn-danger btn-sm mt-2 delete-request-btn" data-request-id="${request.id}" data-request-type="${request.type}">Sil</button>` : ''}
                </div>
            `;
        }).join('');
    }

    // Modal functions
    function openCreateModal(type) {
        document.getElementById('requestType').value = type;
        const modalTitle = type === 'give' ? 'Verme' : 'Alma';
        document.getElementById('modalTitle').textContent = `${modalTitle} Talebi OluÅŸtur`;
        document.getElementById('createModal').classList.remove('hidden');
    }

    function closeCreateModal() {
        document.getElementById('createModal').classList.add('hidden');
        document.getElementById('createRequestForm').reset();
        document.getElementById('createError').classList.add('hidden');
        const submitBtn = document.getElementById('submitCreateBtn');
        submitBtn.disabled = false;
        submitBtn.querySelector('.btn-text').classList.remove('hidden');
        submitBtn.querySelector('.btn-loading').classList.add('hidden');
    }

    function openChat(userId, userName, requestId = null, requestType = null) {
        let url = `/Chat?userId=${userId}&userName=${encodeURIComponent(userName)}`;
        if (requestId && requestType) {
            url += `&requestId=${requestId}&requestType=${requestType}`;
        }
        window.location.href = url;
    }

    async function deleteRequest(id) {
        if (!confirm('Bu talebi silmek istediÄŸinizden emin misiniz?')) return;
        try {
            await mealRequestService.delete(id);
            loadRequests();
        } catch (error) {
            alert('Talep silinemedi: ' + error.message);
        }
    }

    async function deleteFingerprint(id) {
        if (!confirm('Bu parmak izini silmek istediÄŸinizden emin misiniz?')) return;
        try {
            await fingerprintService.delete(id);
            loadRequests();
        } catch (error) {
            alert('Parmak izi silinemedi: ' + error.message);
        }
    }

    document.getElementById('createGiveBtn').addEventListener('click', () => {
        openCreateModal('give');
    });

    document.getElementById('createTakeBtn').addEventListener('click', () => {
        openCreateModal('take');
    });

    document.getElementById('closeCreateModalBtn').addEventListener('click', closeCreateModal);
    document.getElementById('cancelCreateModalBtn').addEventListener('click', closeCreateModal);

    document.getElementById('createRequestForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const errorDiv = document.getElementById('createError');
        const submitBtn = document.getElementById('submitCreateBtn');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnLoading = submitBtn.querySelector('.btn-loading');
        errorDiv.classList.add('hidden');
        submitBtn.disabled = true;
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');

        const requestType = document.getElementById('requestType').value; 
        const mealType = document.getElementById('mealType').value;
        const preferredDate = document.getElementById('preferredDate').value || null;
        const preferredStartTime = document.getElementById('preferredStartTime').value || null;
        const preferredEndTime = document.getElementById('preferredEndTime').value || null;
        const notes = document.getElementById('notes').value.trim() || null;

        if (!mealType) {
            errorDiv.textContent = 'LÃ¼tfen Ã¶ÄŸÃ¼n tÃ¼rÃ¼ seÃ§iniz';
            errorDiv.classList.remove('hidden');
            submitBtn.disabled = false;
            btnText.classList.remove('hidden');
            btnLoading.classList.add('hidden');
            return;
        }

        try {
            const startTime = preferredStartTime ? `${preferredStartTime}:00` : null;
            const endTime = preferredEndTime ? `${preferredEndTime}:00` : null;
            if (requestType === 'give') {
                await fingerprintService.create(mealType, preferredDate, startTime, endTime, notes);
            } else {
                await mealRequestService.create(mealType, preferredDate, startTime, endTime, notes);
            }
            closeCreateModal();
            loadRequests();
        } catch (error) {
            errorDiv.textContent = error.message || 'Talep oluÅŸturulamadÄ±';
            errorDiv.classList.remove('hidden');
        } finally {
            submitBtn.disabled = false;
            btnText.classList.remove('hidden');
            btnLoading.classList.add('hidden');
        }
    });

    document.getElementById('createModal').addEventListener('click', (e) => {
        if (e.target.id === 'createModal') {
            closeCreateModal();
        }
    });

    document.addEventListener('click', (e) => {
        const requestCard = e.target.closest('.request-card');
        if (requestCard && !e.target.closest('.delete-request-btn')) {
            const userId = requestCard.dataset.userId;
            const userName = requestCard.dataset.userName;
            const requestId = requestCard.dataset.requestId;
            const requestType = requestCard.dataset.requestType;
            if (userId && userName) {
                openChat(userId, userName, requestId, requestType);
            }
        }

        if (e.target.classList.contains('delete-request-btn')) {
            e.stopPropagation();
            const requestId = e.target.dataset.requestId;
            const requestType = e.target.dataset.requestType;
            if (requestId) {
                if (requestType === 'fingerprint') {
                    deleteFingerprint(requestId);
                } else {
                    deleteRequest(requestId);
                }
            }
        }
    });
 
    loadRequests();
</script>
}