@page
@model DashboardModel
@{
    ViewData["Title"] = "Ana Sayfa - Payona";
}

<!-- Ä°kon KÃ¼tÃ¼phanesi -->
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<style>
    /* === DASHBOARD Ã–ZEL STÄ°LLERÄ° === */
    
    /* Ä°statistik KartlarÄ± (Gradient) */
    .stat-card {
        padding: 1.5rem;
        border-radius: 15px;
        color: white;
        position: relative;
        overflow: hidden;
        flex: 1;
        min-width: 200px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s;
    }
    .stat-card:hover { transform: translateY(-5px); }
    
    .stat-card.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-card.green { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .stat-card.purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

    .stat-value { font-size: 2rem; font-weight: 700; margin-top: 5px; }
    .stat-label { font-size: 0.9rem; opacity: 0.9; }
    .stat-icon { position: absolute; right: 15px; bottom: 15px; font-size: 3rem; opacity: 0.2; }

    /* Ana Kartlar */
    .dashboard-card {
        background: var(--bg-card);
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 20px var(--shadow-color);
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
    }

    /* Talep Listesi KartlarÄ± */
    .request-item {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 8px var(--shadow-color);
    }

    .request-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px var(--shadow-color);
        border-color: var(--brand-primary);
    }

    /* Verme Talebi (YeÅŸil Ã‡izgi) */
    .request-item[data-request-type="fingerprint"] {
        border-left: 5px solid #43e97b;
        background: linear-gradient(to right, rgba(67, 233, 123, 0.05), var(--bg-card));
    }
    
    /* Alma Talebi (Mavi Ã‡izgi) */
    .request-item[data-request-type="mealRequest"] {
        border-left: 5px solid #4facfe;
        background: linear-gradient(to right, rgba(79, 172, 254, 0.05), var(--bg-card));
    }

    .request-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .user-info { 
        font-weight: 600; 
        font-size: 1.1rem; 
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .user-info i {
        font-size: 1.3rem;
        color: var(--brand-primary);
    }
    .meal-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(67, 233, 123, 0.1));
        color: var(--text-main);
        border: 1px solid var(--border-color);
    }

    /* Butonlar */
    .action-btn {
        padding: 0.8rem 1.5rem;
        border-radius: 10px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
        color: white;
    }

    .btn-give { background: linear-gradient(135deg, #43e97b, #38f9d7); box-shadow: 0 4px 10px rgba(67, 233, 123, 0.3); color: #1a472a; }
    .btn-take { background: linear-gradient(135deg, #4facfe, #00f2fe); box-shadow: 0 4px 10px rgba(79, 172, 254, 0.3); color: #0f3460; }
    
    .btn-give:hover, .btn-take:hover { transform: translateY(-2px); filter: brightness(1.05); }

    /* Modal (Popup) */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        backdrop-filter: blur(5px);
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal-content {
        background: var(--bg-card);
        width: 100%;
        max-width: 500px;
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        transform: scale(0.8);
        transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-content { transform: scale(1); }

    /* YÃ¼kleniyor Spinner */
    .spinner {
        border: 3px solid rgba(0,0,0,0.1);
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border-left-color: var(--brand-primary);
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* BaÅŸlÄ±klar */
    h1, h2, h3 { color: var(--text-main); }
    .section-title {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 1.5rem;
        font-size: 1.4rem;
    }
</style>

<div class="container" style="max-width: 1200px; margin: 0 auto; padding-bottom: 3rem;">
    
    <!-- Ãœst BaÅŸlÄ±k ve Butonlar -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h1 style="font-size: 2rem; margin-bottom: 0.5rem;">HoÅŸ geldin, <span id="welcomeName" style="color: var(--brand-primary);">@(User.Identity?.Name ?? "Ã–ÄŸrenci")</span> ðŸ‘‹</h1>
            <p style="color: var(--text-secondary);">BugÃ¼n ne paylaÅŸmak istersin?</p>
        </div>
        
        <div style="display: flex; gap: 1rem;">
            <button class="action-btn btn-give" id="createGiveBtn">
                <i class="ri-hand-heart-fill"></i> Yemek Ver
            </button>
            <button class="action-btn btn-take" id="createTakeBtn">
                <i class="ri-restaurant-fill"></i> Yemek Al
            </button>
        </div>
    </div>

    <!-- Ä°statistik KartlarÄ± -->
    <div style="display: flex; gap: 1.5rem; margin-bottom: 2rem; flex-wrap: wrap;">
        <div class="stat-card blue">
            <div class="stat-label">Toplam Talep</div>
            <div class="stat-value" id="totalRequestsCreated">0</div>
            <i class="ri-file-list-3-line stat-icon"></i>
        </div>
        <div class="stat-card green">
            <div class="stat-label">BaÅŸarÄ±lÄ± EÅŸleÅŸme</div>
            <div class="stat-value" id="totalMatchesAccepted">0</div>
            <i class="ri-check-double-line stat-icon"></i>
        </div>
        <div class="stat-card purple">
            <div class="stat-label">Toplam EtkileÅŸim</div>
            <div class="stat-value" id="totalMatchesCreated">0</div>
            <i class="ri-refresh-line stat-icon"></i>
        </div>
    </div>

    <!-- Grafik AlanÄ± -->
    <div class="dashboard-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="font-size: 1.2rem;">HaftalÄ±k Aktivite</h2>
            <select id="periodSelect" class="form-control" style="width: auto; padding: 0.5rem 1rem;">
                <option value="day">GÃ¼nlÃ¼k</option>
                <option value="week" selected>HaftalÄ±k</option>
                <option value="month">AylÄ±k</option>
                <option value="year">YÄ±llÄ±k</option>
            </select>
        </div>
        <canvas id="activityCanvas" style="width: 100%; height: 250px;"></canvas>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem;">
        
        <!-- Sol SÃ¼tun: Benim Taleplerim -->
        <section>
            <h2 class="section-title">
                <i class="ri-user-star-line" style="color: var(--brand-primary);"></i> Senin Taleplerin
            </h2>
            <div id="myRequests">
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px;">YÃ¼kleniyor...</p>
                </div>
            </div>
        </section>

        <!-- SaÄŸ SÃ¼tun: DiÄŸer Ã–ÄŸrenciler -->
        <section>
            <h2 class="section-title">
                <i class="ri-community-line" style="color: var(--brand-secondary);"></i> KampÃ¼steki Talepler
            </h2>
            <div id="otherRequests">
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px;">YÃ¼kleniyor...</p>
                </div>
            </div>
        </section>
    </div>

</div>

<!-- MODAL: Talep OluÅŸtur -->
<div id="createModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 id="modalTitle" style="font-size: 1.5rem;">Talep OluÅŸtur</h2>
            <button id="closeCreateModalBtn" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">&times;</button>
        </div>
        
        <form id="createRequestForm">
            <input type="hidden" id="requestType" />
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Ã–ÄŸÃ¼n TÃ¼rÃ¼</label>
                <select id="mealType" class="form-control" required>
                    <option value="">SeÃ§iniz...</option>
                    <option value="lunch">Ã–ÄŸle YemeÄŸi</option>
                    <option value="dinner">AkÅŸam YemeÄŸi</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Tarih</label>
                    <input type="date" id="preferredDate" class="form-control" />
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Saat AralÄ±ÄŸÄ±</label>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <input type="time" id="preferredStartTime" class="form-control" />
                        <span>-</span>
                        <input type="time" id="preferredEndTime" class="form-control" />
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">Notlar</label>
                <textarea id="notes" class="form-control" rows="3" placeholder="Ã–rn: Yemekhanede 2. turnike Ã¶nÃ¼nde olacaÄŸÄ±m..."></textarea>
            </div>

            <div id="createError" class="text-error" style="display: none; color: #ff6b6b; margin-bottom: 1rem;"></div>

            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn-secondary" id="cancelCreateModalBtn" style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: transparent; color: var(--text-main); cursor: pointer;">Ä°ptal</button>
                <button type="submit" id="submitCreateBtn" style="flex: 2; padding: 10px; border-radius: 8px; border: none; background: var(--brand-primary); color: white; cursor: pointer; font-weight: 600;">
                    <span class="btn-text">OluÅŸtur</span>
                    <span class="btn-loading" style="display: none;"><i class="fas fa-spinner fa-spin"></i></span>
                </button>
            </div>
        </form>
    </div>
</div>


@section Scripts {
<script type="module">
    import { authService } from '/js/modules/auth.js';
    import { mealRequestService } from '/js/modules/mealRequest.js';
    import { fingerprintService } from '/js/modules/fingerprint.js';
    import { matchService } from '/js/modules/match.js';

    // === 1. GÃœVENLÄ°K KONTROLÃœ ===
    if (!authService.isAuthenticated()) {
        window.location.href = '/';
    }
    const user = authService.getCurrentUser();
    if (authService.requiresDormInfo()) {
        window.location.href = '/DormInfo';
    }

    // === 2. KULLANICI ADI GÃ–STERÄ°MÄ° ===
    if (user && user.name) {
        document.getElementById('welcomeName').textContent = user.name;
    }

    // === 3. Ä°STATÄ°STÄ°K & GRAFÄ°K ===
    let currentPeriod = 'week';
    let activityData = null;

    // Veriyi gruplandÄ±rma (HaftalÄ±k/AylÄ±k vb.)
    function aggregateData(dailyStats, period) {
        if (!dailyStats || dailyStats.length === 0) return [];
        if (period === 'day' || period === 'week') {
            // Tarih formatÄ±nÄ± normalize et
            return dailyStats.map(stat => ({
                date: stat.date || stat.Date,
                requestsCreated: stat.requestsCreated || stat.RequestsCreated || 0,
                matchesCreated: stat.matchesCreated || stat.MatchesCreated || 0,
                matchesAccepted: stat.matchesAccepted || stat.MatchesAccepted || 0
            }));
        }

        // Ay ve YÄ±l iÃ§in gruplama mantÄ±ÄŸÄ±
        const groupedData = {};
        dailyStats.forEach(stat => {
            const date = new Date(stat.date || stat.Date);
            let key;
            if (period === 'month') {
                // Haftalara bÃ¶l
                const weekNum = Math.ceil(date.getDate() / 7);
                key = `${date.getFullYear()}-${date.getMonth()}-week-${weekNum}`;
            } else if (period === 'year') {
                // Aylara bÃ¶l
                key = `${date.getFullYear()}-${date.getMonth()}`;
            }

            if (!groupedData[key]) {
                groupedData[key] = {
                    date: date,
                    requestsCreated: 0, 
                    matchesCreated: 0, 
                    matchesAccepted: 0
                };
            }
            groupedData[key].requestsCreated += (stat.requestsCreated || stat.RequestsCreated || 0);
            groupedData[key].matchesCreated += (stat.matchesCreated || stat.MatchesCreated || 0);
            groupedData[key].matchesAccepted += (stat.matchesAccepted || stat.MatchesAccepted || 0);
        });
        return Object.values(groupedData).sort((a, b) => a.date - b.date);
    }

    async function loadActivityStats(period) {
        try {
            const stats = await matchService.getActivityStats(period);
            activityData = stats;
            
            // SayÄ±larÄ± gÃ¼ncelle
            document.getElementById('totalRequestsCreated').textContent = stats.totalRequestsCreated || 0;
            document.getElementById('totalMatchesAccepted').textContent = stats.totalMatchesAccepted || 0;
            document.getElementById('totalMatchesCreated').textContent = stats.totalMatchesCreated || 0;

            const processedData = aggregateData(stats.dailyStats || stats.DailyStats || [], period);
            if (window.drawChart) {
                drawChart(processedData);
            }

        } catch (error) {
            console.error('Stats error:', error);
        }
    }

    // Basit Canvas Ã‡izimi
    function initCanvas() {
        const canvas = document.getElementById('activityCanvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k ayarÄ±
        const resizeCanvas = () => {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = 250;
            // Canvas yeniden boyutlandÄ±ÄŸÄ±nda grafiÄŸi tekrar Ã§iz
            if (activityData) {
                const processedData = aggregateData(activityData.dailyStats, currentPeriod);
                drawChart(processedData);
            }
        };
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        window.drawChart = function(data) {
            if (!canvas || !ctx) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (!data || data.length === 0) {
                ctx.fillStyle = '#aaa';
                ctx.font = '14px Poppins';
                ctx.textAlign = 'center';
                ctx.fillText('Veri Yok', canvas.width/2, canvas.height/2);
                return;
            }

            const padding = 40;
            const width = canvas.width - padding*2;
            const height = canvas.height - padding*2;
            const maxVal = Math.max(...data.map(d => Math.max(d.requestsCreated || 0, d.matchesAccepted || 0, d.matchesCreated || 0)), 1);
            const stepX = data.length > 1 ? width / (data.length - 1) : width;

            // Grid Ã§izgileri
            ctx.strokeStyle = 'rgba(0,0,0,0.1)';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                const y = padding + (height / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + width, y);
                ctx.stroke();
            }

            // Ã‡ubuklarÄ± Ã§iz
            data.forEach((d, i) => {
                const x = padding + i * stepX;
                const barW = Math.max(stepX * 0.6, 20);
                
                // Mavi (Talep)
                const h1 = maxVal > 0 ? (d.requestsCreated || 0) / maxVal * height : 0;
                ctx.fillStyle = '#4facfe';
                ctx.fillRect(x - barW/2, padding + height - h1, barW, h1);
                
                // YeÅŸil (EÅŸleÅŸme - Accepted)
                const h2 = maxVal > 0 ? (d.matchesAccepted || 0) / maxVal * height : 0;
                ctx.fillStyle = '#43e97b';
                ctx.fillRect(x - barW/2, padding + height - h1 - h2, barW, h2);
                
                // Tarih etiketleri
                if (i % Math.ceil(data.length / 7) === 0 || i === data.length - 1) {
                    const date = new Date(d.date || d.Date);
                    const dateStr = currentPeriod === 'day' 
                        ? date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' })
                        : date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
                    ctx.fillStyle = '#636E72';
                    ctx.font = '10px Poppins';
                    ctx.textAlign = 'center';
                    ctx.fillText(dateStr, x, canvas.height - 10);
                }
            });
        }
    }
    
    // === 4. TALEPLERÄ° LÄ°STELEME ===
    async function loadRequests() {
        const myContainer = document.getElementById('myRequests');
        const otherContainer = document.getElementById('otherRequests');

        try {
            // Paralel istek atalÄ±m
            const [myReqs, allReqs, myFPs, allFPs] = await Promise.all([
                mealRequestService.getMy(),
                mealRequestService.getAll(),
                fingerprintService.getMy(),
                fingerprintService.getAll()
            ]);

            // Verileri BirleÅŸtir ve SÄ±rala
            const myRequests = [
                ...myReqs.filter(r => r.status !== 'cancelled').map(r => ({ ...r, type: 'mealRequest' })),
                ...myFPs.filter(f => f.status !== 'cancelled').map(f => ({ ...f, type: 'fingerprint' }))
            ].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

            const otherRequests = [
                ...allReqs.filter(r => r.userId !== user.id && r.status === 'active').map(r => ({ ...r, type: 'mealRequest' })),
                ...allFPs.filter(f => f.userId !== user.id && f.status === 'active').map(f => ({ ...f, type: 'fingerprint' }))
            ].sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

            renderList(myContainer, myRequests, true);
            renderList(otherContainer, otherRequests, false);

        } catch (error) {
            console.error(error);
            myContainer.innerHTML = '<p style="color:red">Veriler yÃ¼klenemedi.</p>';
        }
    }

    function renderList(container, items, isOwn) {
        if (!items.length) {
            container.innerHTML = '<div style="text-align:center; color:var(--text-secondary); padding:1rem;">ðŸ“­ HenÃ¼z talep yok.</div>';
            return;
        }

        container.innerHTML = items.map(item => {
            const isGive = item.type === 'fingerprint'; // Verme = Fingerprint
            const label = isGive ? 'Verme Ä°steÄŸi' : 'Alma Ä°steÄŸi';
            const icon = isGive ? 'ri-hand-heart-line' : 'ri-restaurant-line';
            const statusColor = item.status === 'active' ? '#43e97b' : '#aaa';
            const displayName = isOwn ? (user.name || 'Ben') : (item.userName || item.user?.name || 'KullanÄ±cÄ±');

            // Tarih formatla
            const dateStr = item.preferredDate || item.availableDate 
                ? new Date(item.preferredDate || item.availableDate).toLocaleDateString('tr-TR', { 
                    day: 'numeric', 
                    month: 'short',
                    year: 'numeric'
                }) 
                : 'Tarih BelirtilmemiÅŸ';

            return `
            <div class="request-item" 
                 data-request-id="${item.id}"
                 data-request-type="${item.type}"
                 data-user-id="${item.userId}"
                 data-user-name="${item.userName || item.user?.name || ''}">
                
                <div class="request-header">
                    <span class="user-info">
                        <i class="${icon}"></i> ${displayName}
                        ${isOwn ? '<span style="font-size:0.75rem; color:var(--text-secondary); margin-left:5px;">(Benim Talebim)</span>' : ''}
                    </span>
                    <span class="meal-badge">${dateStr}</span>
                </div>
                
                <div style="margin: 0.8rem 0;">
                    <p style="color:var(--text-secondary); font-size:0.95rem; margin-bottom: 0.5rem; line-height:1.5;">
                        <i class="ri-restaurant-line" style="color:var(--brand-secondary); margin-right:5px;"></i>
                        <strong style="color:var(--text-main);">${item.mealType === 'lunch' ? 'Ã–ÄŸle YemeÄŸi' : 'AkÅŸam YemeÄŸi'}</strong>
                    </p>
                    ${item.notes || item.description ? `
                        <p style="color:var(--text-secondary); font-size:0.9rem; margin-top:0.5rem; padding:0.8rem; background:var(--bg-input); border-radius:8px; border-left:3px solid var(--brand-secondary);">
                            ${item.notes || item.description}
                        </p>
                    ` : ''}
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:1rem; padding-top:1rem; border-top:1px solid var(--border-color);">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:0.8rem; color:var(--text-placeholder);">
                            Durum:
                        </span>
                        <span style="color:${statusColor}; font-weight:bold; font-size:0.85rem; padding:4px 10px; background:${statusColor === '#43e97b' ? 'rgba(67, 233, 123, 0.1)' : 'rgba(170, 170, 170, 0.1)'}; border-radius:12px;">
                            ${item.status === 'active' ? 'Aktif' : item.status === 'matched' ? 'EÅŸleÅŸti' : item.status}
                        </span>
                    </div>
                    
                    ${isOwn 
                        ? `<button class="btn-delete" style="color:#ff6b6b; background:rgba(255,107,107,0.1); border:1px solid rgba(255,107,107,0.3); cursor:pointer; padding:6px 12px; border-radius:8px; transition:all 0.2s; font-size:0.85rem; font-weight:600; display:flex; align-items:center; gap:5px;" onmouseover="this.style.background='rgba(255,107,107,0.2)'" onmouseout="this.style.background='rgba(255,107,107,0.1)'">
                            <i class="ri-delete-bin-line"></i> Sil
                           </button>` 
                        : `<div style="display:flex; align-items:center; gap:8px; color:var(--brand-primary); font-weight:600; font-size:0.9rem;">
                            <i class="ri-message-3-line"></i> MesajlaÅŸ
                           </div>`
                    }
                </div>
            </div>`;
        }).join('');
    }

    // === 5. MODAL Ä°ÅžLEMLERÄ° (AÃ§/Kapa) ===
    const modal = document.getElementById('createModal');

    function openModal(type) {
        document.getElementById('requestType').value = type;
        document.getElementById('modalTitle').textContent = type === 'give' ? 'Yemek Verme Talebi' : 'Yemek Alma Talebi';
        modal.classList.add('active');
    }

    function closeModal() {
        modal.classList.remove('active');
        document.getElementById('createRequestForm').reset();
    }

    document.getElementById('createGiveBtn').addEventListener('click', () => openModal('give'));
    document.getElementById('createTakeBtn').addEventListener('click', () => openModal('take'));
    document.getElementById('closeCreateModalBtn').addEventListener('click', closeModal);
    document.getElementById('cancelCreateModalBtn').addEventListener('click', closeModal);

    // === 6. TALEP OLUÅžTURMA ===
    document.getElementById('createRequestForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitCreateBtn');
        const errorDiv = document.getElementById('createError');
        
        // UI Durumu
        btn.querySelector('.btn-text').style.display = 'none';
        btn.querySelector('.btn-loading').style.display = 'inline';
        btn.disabled = true;
        errorDiv.style.display = 'none';

        const type = document.getElementById('requestType').value;
        const mealType = document.getElementById('mealType').value;
        const date = document.getElementById('preferredDate').value;
        const start = document.getElementById('preferredStartTime').value;
        const end = document.getElementById('preferredEndTime').value;
        const notes = document.getElementById('notes').value;

        try {
            const sTime = start ? start + ':00' : null;
            const eTime = end ? end + ':00' : null;

            if (type === 'give') {
                await fingerprintService.create(mealType, date, sTime, eTime, notes);
            } else {
                await mealRequestService.create(mealType, date, sTime, eTime, notes);
            }
            
            closeModal();
            loadRequests(); // Listeyi yenile
            loadActivityStats(currentPeriod); // GrafiÄŸi yenile

        } catch (err) {
            errorDiv.textContent = err.message || 'Hata oluÅŸtu';
            errorDiv.style.display = 'block';
        } finally {
            btn.querySelector('.btn-text').style.display = 'inline';
            btn.querySelector('.btn-loading').style.display = 'none';
            btn.disabled = false;
        }
    });

    // === 7. KARTA TIKLAMA (SOHBETE GÄ°T) ===
    document.addEventListener('click', async (e) => {
        // Silme butonu kontrolÃ¼
        if (e.target.closest('.btn-delete') || e.target.classList.contains('btn-delete')) {
            e.preventDefault();
            e.stopPropagation();
            const card = e.target.closest('.request-item');
            if (!card) return;
            
            const id = card.dataset.requestId;
            const type = card.dataset.requestType;
            
            if (confirm('Silmek istediÄŸine emin misin?')) {
                try {
                    if (type === 'fingerprint') {
                        await fingerprintService.delete(id);
                    } else {
                        await mealRequestService.delete(id);
                    }
                    loadRequests(); // Listeyi yenile
                    loadActivityStats(currentPeriod); // GrafiÄŸi yenile
                } catch(err) { 
                    alert('Silinemedi: ' + (err.message || 'Bilinmeyen hata'));
                }
            }
            return;
        }

        // Karta tÄ±klama kontrolÃ¼ (Sohbet)
        const card = e.target.closest('.request-item');
        if (card && !e.target.closest('.btn-delete')) {
            const userId = card.dataset.userId;
            const userName = card.dataset.userName;
            const reqId = card.dataset.requestId;
            const reqType = card.dataset.requestType;

            // Kendi kartÄ±mÄ±z deÄŸilse sohbete git
            if (userId != user.id) {
                window.location.href = `/Chat?userId=${encodeURIComponent(userId)}&userName=${encodeURIComponent(userName || 'KullanÄ±cÄ±')}&requestId=${encodeURIComponent(reqId)}&requestType=${encodeURIComponent(reqType)}`;
            }
        }
    });

    // === BAÅžLATMA ===
    initCanvas();
    loadActivityStats('week');
    loadRequests();

    // DÃ¶nem deÄŸiÅŸince
    document.getElementById('periodSelect').addEventListener('change', (e) => {
        currentPeriod = e.target.value;
        loadActivityStats(currentPeriod);
    });

</script>
}