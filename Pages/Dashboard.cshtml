@page
@model DashboardModel
@{
    ViewData["Title"] = "Ana Sayfa - Payona";
}

<div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>Ana Sayfa</h1>
        <div class="flex gap-2">
            <button class="btn btn-primary" id="createGiveBtn" data-type="give">Verme Talebi Olu≈ütur</button>
            <button class="btn btn-secondary" id="createTakeBtn" data-type="take">Alma Talebi Olu≈ütur</button>
        </div>
    </div>

    <!-- Canvas Visualization -->
    <div class="card mb-4">
        <h2 class="card-title mb-2">Aktivite √ñzeti</h2>
        <canvas id="activityCanvas" width="800" height="200" style="width: 100%; max-width: 800px; height: 200px; border-radius: 0.5rem; background: var(--bg-secondary);"></canvas>
    </div>

    <!-- My Requests Section -->
    <section class="mb-4">
        <h2 style="margin-bottom: 1rem;">Taleplerim</h2>
        <div id="myRequests" class="grid grid-cols-1 gap-4">
            <div class="text-center" style="padding: 2rem; color: var(--text-secondary);">
                <div class="spinner" style="margin: 0 auto;"></div>
                <p class="mt-2">Y√ºkleniyor...</p>
            </div>
        </div>
    </section>

    <!-- Other Students' Requests Section -->
    <section>
        <h2 style="margin-bottom: 1rem;">Diƒüer √ñƒürencilerin Talepleri</h2>
        <div id="otherRequests" class="grid grid-cols-1 gap-4">
            <div class="text-center" style="padding: 2rem; color: var(--text-secondary);">
                <div class="spinner" style="margin: 0 auto;"></div>
                <p class="mt-2">Y√ºkleniyor...</p>
            </div>
        </div>
    </section>
</div>

<!-- Create Request Modal -->
<div id="createModal" class="modal-overlay hidden">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modalTitle">Talep Olu≈ütur</h2>
            <button class="modal-close" id="closeCreateModalBtn">&times;</button>
        </div>
        <form id="createRequestForm">
            <input type="hidden" id="requestType" />
            <div class="form-group">
                <label class="form-label" for="mealType">√ñƒü√ºn T√ºr√º</label>
                <select id="mealType" class="form-select" required>
                    <option value="">√ñƒü√ºn Se√ßiniz</option>
                    <option value="lunch">√ñƒüle Yemeƒüi</option>
                    <option value="dinner">Ak≈üam Yemeƒüi</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label" for="preferredDate">Tercih Edilen Tarih (ƒ∞steƒüe Baƒülƒ±)</label>
                <input type="date" id="preferredDate" class="form-input" />
            </div>
            <div class="form-group">
                <label class="form-label" for="preferredStartTime">Ba≈ülangƒ±√ß Saati (ƒ∞steƒüe Baƒülƒ±)</label>
                <input type="time" id="preferredStartTime" class="form-input" />
            </div>
            <div class="form-group">
                <label class="form-label" for="preferredEndTime">Biti≈ü Saati (ƒ∞steƒüe Baƒülƒ±)</label>
                <input type="time" id="preferredEndTime" class="form-input" />
            </div>
            <div class="form-group">
                <label class="form-label" for="notes">Notlar (ƒ∞steƒüe Baƒülƒ±)</label>
                <textarea id="notes" class="form-textarea" placeholder="Ek bilgiler..."></textarea>
            </div>
            <div id="createError" class="text-error hidden mb-2"></div>
            <div class="flex gap-2">
                <button type="submit" class="btn btn-primary" style="flex: 1;" id="submitCreateBtn">
                    <span class="btn-text">Olu≈ütur</span>
                    <span class="btn-loading hidden">Olu≈üturuluyor...</span>
                </button>
                <button type="button" class="btn btn-secondary" id="cancelCreateModalBtn">ƒ∞ptal</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script type="module">
        import { authService } from '/js/modules/auth.js';
        import { mealRequestService } from '/js/modules/mealRequest.js';
        import { fingerprintService } from '/js/modules/fingerprint.js';

        // Check authentication
        if (!authService.isAuthenticated()) {
            window.location.href = '/';
        }

        const user = authService.getCurrentUser();
        if (authService.requiresDormInfo()) {
            window.location.href = '/DormInfo';
        }

        // Initialize Canvas
        function initCanvas() {
            const canvas = document.getElementById('activityCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = 200;

            // Draw activity chart
            function drawChart() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const padding = 40;
                const chartWidth = canvas.width - padding * 2;
                const chartHeight = canvas.height - padding * 2;
                
                // Draw grid
                ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border-color');
                ctx.lineWidth = 1;
                
                // Horizontal lines
                for (let i = 0; i <= 5; i++) {
                    const y = padding + (chartHeight / 5) * i;
                    ctx.beginPath();
                    ctx.moveTo(padding, y);
                    ctx.lineTo(canvas.width - padding, y);
                    ctx.stroke();
                }
                
                // Vertical lines
                for (let i = 0; i <= 7; i++) {
                    const x = padding + (chartWidth / 7) * i;
                    ctx.beginPath();
                    ctx.moveTo(x, padding);
                    ctx.lineTo(x, canvas.height - padding);
                    ctx.stroke();
                }
                
                // Draw sample data (simulated activity)
                const data = [12, 19, 15, 25, 22, 18, 20];
                const maxValue = Math.max(...data);
                const barWidth = chartWidth / 7 - 10;
                
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
                
                data.forEach((value, index) => {
                    const barHeight = (value / maxValue) * chartHeight;
                    const x = padding + (chartWidth / 7) * index + 5;
                    const y = canvas.height - padding - barHeight;
                    
                    ctx.fillRect(x, y, barWidth, barHeight);
                    
                    // Add animation
                    ctx.save();
                    ctx.globalAlpha = 0.8;
                    ctx.fillRect(x, y, barWidth, barHeight);
                    ctx.restore();
                });
                
                // Draw labels
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                days.forEach((day, index) => {
                    const x = padding + (chartWidth / 7) * index + chartWidth / 14;
                    ctx.fillText(day, x, canvas.height - 10);
                });
            }
            
            drawChart();
            
            // Redraw on resize
            window.addEventListener('resize', () => {
                canvas.width = canvas.offsetWidth;
                drawChart();
            });
        }

        initCanvas();

        // Load requests
        async function loadRequests() {
            try {
                const [myMealRequests, allMealRequests, myFingerprints, allFingerprints] = await Promise.all([
                    mealRequestService.getMy(),
                    mealRequestService.getAll(),
                    fingerprintService.getMy(),
                    fingerprintService.getAll()
                ]);

                const user = authService.getCurrentUser();
                
                // Combine my requests (both meal requests and fingerprints)
                const myRequests = [
                    ...myMealRequests.map(req => ({ ...req, type: 'mealRequest' })),
                    ...myFingerprints.map(fp => ({ ...fp, type: 'fingerprint' }))
                ].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                // Combine other requests (filter by dorm if available)
                const otherMealRequests = allMealRequests.filter(req => {
                    if (req.userId === user.id) return false;
                    if (user.dorm && req.userDorm) {
                        return req.userDorm === user.dorm;
                    }
                    return true; // Show all if dorm info not available
                }).map(req => ({ ...req, type: 'mealRequest' }));

                const otherFingerprints = allFingerprints.filter(fp => {
                    if (fp.userId === user.id) return false;
                    if (user.dorm && fp.userDorm) {
                        return fp.userDorm === user.dorm;
                    }
                    return true; // Show all if dorm info not available
                }).map(fp => ({ ...fp, type: 'fingerprint' }));

                const otherRequests = [...otherMealRequests, ...otherFingerprints]
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                renderRequests('myRequests', myRequests, true);
                renderRequests('otherRequests', otherRequests, false);
            } catch (error) {
                console.error('Error loading requests:', error);
                document.getElementById('myRequests').innerHTML = 
                    '<p class="text-error">Talepler y√ºklenemedi</p>';
                document.getElementById('otherRequests').innerHTML = 
                    '<p class="text-error">Talepler y√ºklenemedi</p>';
            }
        }

        function renderRequests(containerId, requests, isOwn) {
            const container = document.getElementById(containerId);
            
            if (!requests || requests.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">Talep bulunamadƒ±</p>';
                return;
            }

            container.innerHTML = requests.map(request => {
                const isFingerprint = request.type === 'fingerprint';
                const isGive = isFingerprint; // Fingerprint = give, MealRequest = take
                const dateField = isFingerprint ? 'availableDate' : 'preferredDate';
                const startTimeField = isFingerprint ? 'startTime' : 'preferredStartTime';
                const endTimeField = isFingerprint ? 'endTime' : 'preferredEndTime';
                const notesField = isFingerprint ? 'description' : 'notes';
                const deleteAction = isFingerprint ? 'deleteFingerprint' : 'deleteRequest';
                
                return `
                <div class="card request-card" 
                     data-user-id="${request.userId}" 
                     data-user-name="${(request.userName || '').replace(/"/g, '&quot;')}"
                     data-request-id="${request.id}"
                     data-request-type="${request.type}">
                    <div class="flex justify-between items-center mb-2">
                        <span class="request-type ${isGive ? 'give' : 'take'}">
                            ${isGive ? 'üçΩÔ∏è Verme' : 'üç¥ Alma'}
                        </span>
                        <span class="badge badge-primary">${request.status || 'active'}</span>
                    </div>
                    <p><strong>${request.userName || 'Bilinmeyen'}</strong> ${request.userGender ? `(${request.userGender})` : ''}</p>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">
                        √ñƒü√ºn: ${request.mealType === 'lunch' ? '√ñƒüle Yemeƒüi' : request.mealType === 'dinner' ? 'Ak≈üam Yemeƒüi' : request.mealType}
                    </p>
                    ${request[dateField] ? `<p style="color: var(--text-secondary); font-size: 0.9rem;">Tarih: ${new Date(request[dateField]).toLocaleDateString('tr-TR')}</p>` : ''}
                    ${request[startTimeField] && request[endTimeField] ? 
                        `<p style="color: var(--text-secondary); font-size: 0.9rem;">Saat: ${request[startTimeField]} - ${request[endTimeField]}</p>` : ''}
                    ${request[notesField] ? `<p style="margin-top: 0.5rem;">${request[notesField]}</p>` : ''}
                    <p style="color: var(--text-tertiary); font-size: 0.85rem; margin-top: 0.5rem;">
                        ${new Date(request.createdAt).toLocaleString('tr-TR')}
                    </p>
                    ${isOwn ? `<button class="btn btn-danger btn-sm mt-2 delete-request-btn" data-request-id="${request.id}" data-request-type="${request.type}">Sil</button>` : ''}
                </div>
            `;
            }).join('');
        }

        // Modal functions
        function openCreateModal(type) {
            document.getElementById('requestType').value = type;
            const modalTitle = type === 'give' ? 'Verme' : 'Alma';
            document.getElementById('modalTitle').textContent = `${modalTitle} Talebi Olu≈ütur`;
            document.getElementById('createModal').classList.remove('hidden');
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.add('hidden');
            document.getElementById('createRequestForm').reset();
            document.getElementById('createError').classList.add('hidden');
            const submitBtn = document.getElementById('submitCreateBtn');
            submitBtn.disabled = false;
            submitBtn.querySelector('.btn-text').classList.remove('hidden');
            submitBtn.querySelector('.btn-loading').classList.add('hidden');
        }

        function openChat(userId, userName, requestId = null, requestType = null) {
            let url = `/Chat?userId=${userId}&userName=${encodeURIComponent(userName)}`;
            if (requestId && requestType) {
                url += `&requestId=${requestId}&requestType=${requestType}`;
            }
            window.location.href = url;
        }

        async function deleteRequest(id) {
            if (!confirm('Bu talebi silmek istediƒüinizden emin misiniz?')) return;
            
            try {
                await mealRequestService.delete(id);
                loadRequests();
            } catch (error) {
                alert('Talep silinemedi: ' + error.message);
            }
        }

        async function deleteFingerprint(id) {
            if (!confirm('Bu parmak izini silmek istediƒüinizden emin misiniz?')) return;
            
            try {
                await fingerprintService.delete(id);
                loadRequests();
            } catch (error) {
                alert('Parmak izi silinemedi: ' + error.message);
            }
        }

        // Event listeners for buttons
        document.getElementById('createGiveBtn').addEventListener('click', () => {
            openCreateModal('give');
        });

        document.getElementById('createTakeBtn').addEventListener('click', () => {
            openCreateModal('take');
        });

        document.getElementById('closeCreateModalBtn').addEventListener('click', closeCreateModal);
        document.getElementById('cancelCreateModalBtn').addEventListener('click', closeCreateModal);

        // Create request handler
        document.getElementById('createRequestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('createError');
            const submitBtn = document.getElementById('submitCreateBtn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            
            errorDiv.classList.add('hidden');
            submitBtn.disabled = true;
            btnText.classList.add('hidden');
            btnLoading.classList.remove('hidden');

            const requestType = document.getElementById('requestType').value; // 'give' or 'take'
            const mealType = document.getElementById('mealType').value;
            const preferredDate = document.getElementById('preferredDate').value || null;
            const preferredStartTime = document.getElementById('preferredStartTime').value || null;
            const preferredEndTime = document.getElementById('preferredEndTime').value || null;
            const notes = document.getElementById('notes').value.trim() || null;

            // Validation
            if (!mealType) {
                errorDiv.textContent = 'L√ºtfen √∂ƒü√ºn t√ºr√º se√ßiniz';
                errorDiv.classList.remove('hidden');
                submitBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
                return;
            }

            try {
                // Convert time format from HH:mm to HH:mm:ss for TimeSpan
                const startTime = preferredStartTime ? `${preferredStartTime}:00` : null;
                const endTime = preferredEndTime ? `${preferredEndTime}:00` : null;
                
                if (requestType === 'give') {
                    // Create fingerprint (giving meal)
                    await fingerprintService.create(
                        mealType,
                        preferredDate,
                        startTime,
                        endTime,
                        notes
                    );
                } else {
                    // Create meal request (taking meal)
                    await mealRequestService.create(
                        mealType,
                        preferredDate,
                        startTime,
                        endTime,
                        notes
                    );
                }
                
                closeCreateModal();
                loadRequests();
            } catch (error) {
                errorDiv.textContent = error.message || 'Talep olu≈üturulamadƒ±';
                errorDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
            }
        });

        // Close modal on overlay click
        document.getElementById('createModal').addEventListener('click', (e) => {
            if (e.target.id === 'createModal') {
                closeCreateModal();
            }
        });

        // Event delegation for dynamic content
        document.addEventListener('click', (e) => {
            // Handle request card click (open chat)
            const requestCard = e.target.closest('.request-card');
            if (requestCard && !e.target.closest('.delete-request-btn')) {
                const userId = requestCard.dataset.userId;
                const userName = requestCard.dataset.userName;
                const requestId = requestCard.dataset.requestId;
                const requestType = requestCard.dataset.requestType;
                if (userId && userName) {
                    openChat(userId, userName, requestId, requestType);
                }
            }

            // Handle delete request button
            if (e.target.classList.contains('delete-request-btn')) {
                e.stopPropagation();
                const requestId = e.target.dataset.requestId;
                const requestType = e.target.dataset.requestType;
                if (requestId) {
                    if (requestType === 'fingerprint') {
                        deleteFingerprint(requestId);
                    } else {
                        deleteRequest(requestId);
                    }
                }
            }
        });

        // Load initial data
        loadRequests();
    </script>
}

