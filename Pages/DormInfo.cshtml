@page
@model DormInfoModel
@{
    ViewData["Title"] = "Profilinizi Tamamlayın - Payona";
}

<style>
    /* === TASARIM STİLLERİ (Görsel Kısım) === */
    .setup-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 100px);
        padding: 2rem;
    }

    .setup-card {
        background: var(--bg-card);
        border-radius: 20px;
        box-shadow: 0 10px 40px var(--shadow-color);
        width: 100%;
        max-width: 900px;
        display: flex;
        overflow: hidden;
        border: 1px solid var(--border-color);
        animation: fadeInUp 0.8s ease-out;
    }

    /* Sol Taraf (Görsel Banner) */
    .setup-visual {
        flex: 1;
        background: linear-gradient(135deg, var(--brand-secondary), #2193b0);
        padding: 3rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        color: white;
        position: relative;
    }

    .setup-visual i {
        font-size: 5rem;
        margin-bottom: 1.5rem;
        filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
        animation: float 4s ease-in-out infinite;
    }

    .setup-visual h2 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }

    .setup-visual p {
        font-size: 1rem;
        opacity: 0.9;
        line-height: 1.6;
    }

    /* Sağ Taraf (Form Alanı) */
    .setup-form {
        flex: 1.2;
        padding: 3rem;
        background: var(--bg-card);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
        color: var(--text-main);
    }

    .form-select {
        width: 100%;
        padding: 12px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        background-color: var(--bg-input);
        color: var(--text-main);
        font-size: 0.95rem;
        transition: all 0.3s;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23a4b0be%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 0.75rem auto;
    }

    .form-select:focus {
        border-color: var(--brand-secondary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(78, 205, 196, 0.2);
    }

    .btn-finish {
        width: 100%;
        padding: 14px;
        background: var(--brand-secondary);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin-top: 1rem;
        box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
    }

    .btn-finish:hover {
        background: #3ebcb4;
        transform: translateY(-2px);
    }

    .btn-finish:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .text-error {
        color: #ff6b6b;
        background: rgba(255, 107, 107, 0.1);
        padding: 10px;
        border-radius: 8px;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        border-left: 3px solid #ff6b6b;
        display: none;
    }

    @@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @@keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

    /* Mobil Uyumluluk */
    @@media (max-width: 768px) {
        .setup-card { flex-direction: column; }
        .setup-visual { padding: 2rem; flex: 0; }
        .setup-form { padding: 2rem; }
    }
</style>

<div class="setup-container">
    <div class="setup-card">
        <!-- SOL TARAF: Görsel -->
        <div class="setup-visual">
            <i class="fas fa-university"></i>
            <h2>Son Bir Adım!</h2>
            <p>Size en uygun yemek arkadaşlarını bulabilmemiz için yurt bilgilerinizi doğru girmeniz gerekiyor.</p>
            <!-- Dekoratif Arkaplan -->
            <div style="position:absolute; bottom:-30px; left:-30px; width:100px; height:100px; border-radius:50%; background:rgba(255,255,255,0.1);"></div>
        </div>

        <!-- SAĞ TARAF: Form -->
        <div class="setup-form">
            <h3 style="color:var(--text-main); margin-bottom:1.5rem; text-align:center;">Bilgilerini Tamamla</h3>
            
            <form id="dormInfoForm">
                
                <div class="form-group">
                    <label class="form-label" for="gender"><i class="fas fa-venus-mars" style="color:var(--brand-secondary); width:20px;"></i> Cinsiyet</label>
                    <select id="gender" class="form-select" required>
                        <option value="">Cinsiyet Seçiniz</option>
                        <option value="Male">Erkek</option>
                        <option value="Female">Kadın</option>
                        <option value="Other">Diğer</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="city"><i class="fas fa-map-marker-alt" style="color:var(--brand-secondary); width:20px;"></i> Şehir</label>
                    <select id="city" class="form-select" required>
                        <option value="">Önce veriler yükleniyor...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="dorm"><i class="fas fa-building" style="color:var(--brand-secondary); width:20px;"></i> Yurt</label>
                    <select id="dorm" class="form-select" required disabled style="opacity:0.6; cursor:not-allowed;">
                        <option value="">Önce şehir ve cinsiyet seçiniz</option>
                    </select>
                </div>

                <div id="dormInfoError" class="text-error"></div>

                <button type="submit" class="btn-finish" id="submitBtn">
                    <span class="btn-text">Kaydet ve Devam Et <i class="fas fa-arrow-right"></i></span>
                    <span class="btn-loading" style="display:none;"><i class="fas fa-spinner fa-spin"></i> İşleniyor...</span>
                </button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script type="module">
        import { authService } from '/js/modules/auth.js';
        // OLD VERSION LOGIC (Eski kodunun importları)
        import { loadDormData, getCities, getDormsForCity } from '/js/modules/dormData.js';
        
        // --- 1. GÜVENLİK KONTROLÜ ---
        if (!authService.isAuthenticated()) {
            window.location.href = '/';
        }
        const user = authService.getCurrentUser();
        
        // Eğer zaten yurt bilgisi varsa Dashboard'a at
        if (user && !authService.requiresDormInfo()) {
             window.location.href = '/Dashboard';
        }

        // --- 2. VERİ YÜKLEME VE DOLDURMA (ESKİ MANTIK) ---
        let dormData = null;
        const citySelect = document.getElementById('city');
        const dormSelect = document.getElementById('dorm');
        const genderSelect = document.getElementById('gender');

        async function initDormData() {
            try {
                // Verileri dormData.js'den çek
                dormData = await loadDormData();
                const cities = getCities();
                
                // Şehir select'i temizle ve doldur
                citySelect.innerHTML = '<option value="">Şehir Seçiniz</option>';
                cities.forEach(city => {
                    const opt = document.createElement('option');
                    opt.value = city;
                    opt.textContent = city;
                    citySelect.appendChild(opt);
                });

                // Kullanıcıda önceden bir kayıt varsa (Pre-fill)
                if (user) {
                    if (user.gender && user.gender !== "Unknown") {
                        genderSelect.value = user.gender;
                    }
                    if (user.city) {
                        citySelect.value = user.city;
                        // Şehir seçildiyse yurtları otomatik doldurmayı tetikle
                        updateDormOptions();
                    }
                    if (user.dorm) {
                        // Yurtlar dolduktan sonra yurdu seç
                        // setTimeout kullanıyoruz çünkü DOM güncellenmesi gerekebilir
                        setTimeout(() => {
                           dormSelect.value = user.dorm; 
                        }, 100);
                    }
                }
            } catch (err) {
                console.error("Yurt verileri yüklenemedi", err);
                document.getElementById('dormInfoError').textContent = "Yurt verileri yüklenirken hata oluştu.";
                document.getElementById('dormInfoError').style.display = 'block';
            }
        }

        // Yurt Listesini Güncelleme
        function updateDormOptions() {
            const gender = genderSelect.value;
            const city = citySelect.value;
            
            dormSelect.innerHTML = '<option value="">Yurt Seçiniz</option>';
            
            if (gender && city && dormData) {
                // Eski koddan gelen fonksiyonu kullanıyoruz
                const dorms = getDormsForCity(city, gender);
                
                if(dorms && dorms.length > 0) {
                    // Yurt varsa aktifleştir
                    dormSelect.disabled = false;
                    dormSelect.style.opacity = '1';
                    dormSelect.style.cursor = 'pointer';
                    
                    dorms.forEach(dorm => {
                        const opt = document.createElement('option');
                        opt.value = dorm;
                        opt.textContent = dorm;
                        dormSelect.appendChild(opt);
                    });
                } else {
                    dormSelect.innerHTML = '<option value="">Bu kriterde yurt bulunamadı</option>';
                    dormSelect.disabled = true;
                }
            } else {
                dormSelect.innerHTML = '<option value="">Önce şehir ve cinsiyet seçiniz</option>';
                dormSelect.disabled = true;
                dormSelect.style.opacity = '0.6';
                dormSelect.style.cursor = 'not-allowed';
            }
        }

        // Olay Dinleyicileri
        genderSelect.addEventListener('change', updateDormOptions);
        citySelect.addEventListener('change', updateDormOptions);
        
        // Başlat
        initDormData();

        // --- 3. FORM GÖNDERME (TASARIMLI BUTON İLE) ---
        document.getElementById('dormInfoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const errorDiv = document.getElementById('dormInfoError');
            const submitBtn = document.getElementById('submitBtn');
            
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
            
            // Verileri al ve temizle
            const gender = genderSelect.value;
            const city = citySelect.value.trim();
            const dorm = dormSelect.value.trim();
            const userId = user.id;

            if (!gender || !city || !dorm) {
                errorDiv.textContent = 'Lütfen tüm alanları eksiksiz seçiniz.';
                errorDiv.style.display = 'block';
                return;
            }

            // Buton Yükleniyor Modu
            submitBtn.disabled = true;
            submitBtn.querySelector('.btn-text').style.display = 'none';
            submitBtn.querySelector('.btn-loading').style.display = 'block';

            try {
                // API İsteği
                await authService.updateDormInfo(userId, gender, city, dorm);
                
                // Session Storage Güncelle
                const updatedUser = { ...user, gender: gender, city: city, dorm: dorm };
                sessionStorage.setItem('user', JSON.stringify(updatedUser));
                
                // Yönlendir
                window.location.href = '/Dashboard';

            } catch (error) {
                console.error('DormInfo update error:', error);
                
                let errorMessage = error.message || 'Güncelleme başarısız oldu.';
                
                // Hata mesajlarını Türkçeleştirme
                if (errorMessage.includes('expected pattern')) {
                    errorMessage = 'Geçersiz veri formatı.';
                } else if (errorMessage.includes('required')) {
                    errorMessage = 'Lütfen tüm alanları doldurun.';
                }

                errorDiv.textContent = errorMessage;
                errorDiv.style.display = 'block';
                
                // Butonu eski haline getir
                submitBtn.disabled = false;
                submitBtn.querySelector('.btn-text').style.display = 'block';
                submitBtn.querySelector('.btn-loading').style.display = 'none';
            }
        });
    </script>
}