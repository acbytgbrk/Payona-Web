<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Payona</title>
    <link rel="stylesheet" href="~/css/main.css" />
</head>
<body>
    <div class="app-container">
        <nav class="navbar" id="navbar">
            <div class="navbar-content">
                <a href="/" class="navbar-brand">Payona</a>
                <div class="navbar-links" id="navbarLinks">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </nav>

        <main class="main-content">
            @RenderBody()
        </main>

        <footer style="text-align: center; padding: 2rem; color: var(--text-secondary);">
            <p>&copy; 2025 Payona - Öğrenci Yemek Paylaşım Platformu</p>
        </footer>
    </div>

    <script type="module">
        import { authService } from '/js/modules/auth.js';
        import { themeService } from '/js/modules/theme.js';
        import { chatService } from '/js/modules/chat.js';

        // Initialize theme
        themeService.init();
        themeService.updateToggleButton();

        // Setup navigation
        const navbarLinks = document.getElementById('navbarLinks');
        const user = authService.getCurrentUser();
        const isAuthenticated = authService.isAuthenticated();

        // Update unread message count
        async function updateUnreadCount() {
            try {
                const count = await chatService.getUnreadCount();
                const badge = document.getElementById('unreadBadge');
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.error('Error updating unread count:', error);
            }
        }

        if (isAuthenticated && user) {
            navbarLinks.innerHTML = `
                <a href="/Dashboard" class="nav-link">Ana Sayfa</a>
                <a href="/Messages" class="nav-link" id="messagesLink" style="position: relative;">
                    Mesajlar
                    <span id="unreadBadge" class="unread-badge hidden" style="position: absolute; top: -8px; right: -8px; background: var(--accent-danger); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">0</span>
                </a>
                <a href="/Profile" class="nav-link">Profil</a>
                <button class="theme-toggle btn btn-secondary" id="themeToggle" style="padding: 0.5rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6" style="width: 1.25rem; height: 1.25rem;">
                        <path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10 10 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 01.818.162z" clip-rule="evenodd"/>
                    </svg>
                </button>
                <button class="btn btn-secondary" id="logoutBtn">Çıkış Yap</button>
            `;
            
            // Load unread message count
            updateUnreadCount();
            // Update every 10 seconds
            setInterval(updateUnreadCount, 10000);
            
            // Add logout event listener
            document.getElementById('logoutBtn')?.addEventListener('click', async () => {
                await authService.logout();
            });
        } else {
            navbarLinks.innerHTML = `
                <a href="/" class="nav-link">Giriş</a>
                <button class="theme-toggle btn btn-secondary" id="themeToggle" style="padding: 0.5rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6" style="width: 1.25rem; height: 1.25rem;">
                        <path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10 10 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 01.818.162z" clip-rule="evenodd"/>
                    </svg>
                </button>
            `;
        }

        // Theme toggle handler
        document.getElementById('themeToggle')?.addEventListener('click', () => {
            themeService.toggle();
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>

